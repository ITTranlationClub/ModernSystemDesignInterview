# 正确看待粗略的数字

**本节目标:** 学会在粗略计算中使用适当的数字评估系统规模

## 为什么我们使用粗略计算？

分布式系统是 **通过网络连接的各种各样的计算节点** 组成 , 它们可以以多种不同的方式连接。粗略的计算帮助我们在系统设计的层面上忽略系统的细节, 从而关注更重要的方面。

粗略计算的维度(示例)：

- 服务器可以支持的并发 TCP 连接数。
- Web、数据库或缓存服务器每秒可以处理的请求数 (RPS)。
- 服务的存储要求规模。

当进行估算时, 如果采用了错误的估算值, 可能会导致设计出现缺陷。因此,在设计问题中采用正确的估算值是非常重要的. 

我们将在本课中详细讨论系统设计估算相关概念. 这些概念如下:

- 数据中心服务器的类型。
- 不同组件的实际访问延迟。
- 服务器可以处理的 RPS 估计值。
- 带宽、服务器和存储估算方式。

## 数据中心服务器的类型

**数据中心**没有单一类型的服务器。

企业应用使用商用硬件来节省成本并开发可扩展的解决方案。下面，我们将讨论数据中心内常用于处理不同工作负载的服务器类型。

![](https://gitee.com/gaoxiang15125/pictureBed/raw/master/img/1676468554723.png)

### 网络服务器

为了保障可伸缩性，Web 服务器与应用程序服务器分离。

**Web 服务器**是负载均衡器之后的第一个关联点。数据中心的机架上布满了 Web 服务器，这些服务器通常处理来自客户端的 API 调用。

根据所提供的服务，网络服务器中的内存和存储资源可以是中小型的。

但是，此类服务器需要良好的计算资源。

例如，Facebook 使用了具有 32 GB RAM 和 500 GB 存储空间的 Web 服务器。但出于其高端计算需求，它与英特尔合作构建了定制的 16 核处理器。

> [!NOTE]
>
> 本课中引用的许多数字是从 Facebook 于 2011 年开源的数据中心设计中获得的。由于 2004 年以来, 摩尔定律揭示的硬件性能下降，这些数字在今天依然适用。

### 应用服务器

**应用服务器**运行核心应用软件和业务逻辑。

Web 服务器和应用程序服务器之间的区别有些模糊。

应用程序服务器主要提供动态内容，而网络服务器主要向客户端（主要是网络浏览器）提供静态内容。

它们可能需要大量的计算和存储资源。存储资源可以是易失性的也可以是非易失性的。

Facebook 使用的应用程序服务器具有高达 256 GB 的 RAM, 并采用两种类型的存储——传统的旋转磁盘和闪存——容量高达 6.5 TB。

### 存储服务器

随着互联网用户的爆炸式增长，巨头服务存储的数据量成倍增长。

除此之外, 各种类型的数据被存储在不同的存储单元中。

例如，YouTube 使用以下数据存储方案：

1. **Blob 存储方案:**  编码的视频流文件

2. **临时处理队列存储方案:** 容纳每天上传到 YouTube 进行处理的数百小时视频内容。

3. **Bigtable** 专业存储方案: 存储大量视频缩略图。

4. **关系数据库管理系统 (RDBMS) ** 存储用户和视频元数据

5. **Hadoop HDFS** 存储用于分析的数据


存储服务器主要包括结构化（例如SQL）和非结构化（NoSQL）数据管理系统。

回到 Facebook 的例子，我们知道他们使用了存储容量高达 120 TB 的服务器。

凭借使用中的服务器数量，Facebook 能够容纳 EB 级的存储空间。一个艾字节(exbyte)是  10^18 字节。按照惯例，我们以 10 为基数而不是 2 为基数来测量存储和网络带宽。值得注意的是, 服务器的 RAM 只有 32GB。

> **注意：**上述服务器并不是数据中心中唯一的服务器类型。数据中心还需要服务器来提供配置、监控、负载平衡、分析、会计、缓存等服务。

Facebook 开源的数字目前已经过时。在下表中，我们描述了可用于当今数据中心的服务器的功能：

## 典型服务器规格

| 成分          | 数数             |
| ------------- | ---------------- |
| 插座数量      | 2个              |
| 处理器        | 英特尔至强X2686  |
| 芯数          | 36 核（72 线程） |
| 内存          | 256GB            |
| 高速缓存 (L3) | 45MB             |
| 存储容量      | 15 TB            |

上表所示数字来源于 亚马逊裸机服务器，但可能会有或多或少的强大机器支持更高的 RAM（高达 8 TB）、磁盘存储（最多 24 个磁盘，每个磁盘高达 20 TB，大约在 2021 年）和高速缓存（最多 120 MB）。

## 要记住的标准数字

一项服务的规划和实施需要付出很多努力。

如果对机器可以处理的工作负载类型没有任何基本了解, 则几乎不可能对服务部署进行规划。物理延迟在决定机器可以处理的工作量方面起着重要作用。

下表描述了系统设计人员在执行资源估算时应该知道的一些重要数字。

## 重要的延迟

| 成分                                   | 时间（纳秒）          |
| -------------------------------------- | --------------------- |
| 一级缓存参考                           | 0.9                   |
| 二级缓存参考                           | 2.8                   |
| L3缓存参考                             | 12.9                  |
| 主内存参考                             | 100                   |
| 使用 Snzip 压缩 1KB                    | 3,000（3 微秒）       |
| 从内存中顺序读取 1 MB                  | 9,000（9 微秒）       |
| 从 SSD 顺序读取 1 MB                   | 200,000（200 微秒）   |
| 同一数据中心内的往返                   | 500,000（500 微秒）   |
| 以 ~1GB/sec 的速度从 SSD 顺序读取 1 MB | 1,000,000（1 毫秒）   |
| 磁盘寻道                               | 4,000,000（4 毫秒）   |
| 从磁盘顺序读取 1 MB                    | 2,000,000（2 毫秒）   |
| 发包SF->NYC                            | 71,000,000（71 毫秒） |

除了上面列出的延迟之外，还有以典型的单服务器数据存储可以处理的每秒查询数 (QPS) 吞吐量数字。

## 重要费率

|                     |                |
| ------------------- | -------------- |
| MySQL处理的QPS      | 1000           |
| 键值存储处理的QPS   | 10,000         |
| 缓存服务器处理的QPS | 100,000–1 百万 |

上面的数字是近似值，并且会因查询类型（**点** 和 **范围**）、机器规格、数据库设计、索引等多种原因而有很大差异。

> [!NOTE]
>
> **点** : 查找单个项目称为点查询; eg: SELECT * FROM STUDENTS WHERE NAME = "John"; 为点查询, 其搜索的是单个值 "John"
>
> **范围** : 检索边界之间的信息/记录的查询; eg: SELECT * FROM STUDENTS WHERE age BETWEEN 15 AND 18;  

## 请求估计

本节讨论典型服务器每秒可以处理的请求数。在服务器内，资源有限，根据客户端请求的类型，不同的资源可能成为瓶颈。

让我们了解两种类型的请求。

- **CPU 绑定请求：**限制因素是 CPU 的请求类型。
- **内存限制请求：**受机器内存量限制的请求类型。

让我们估算每种请求的 RPS。但在此之前，我们需要做出以下假设：

- 我们的服务器符合我们在上表中定义的典型服务器的规格。
- 操作系统和其他辅助进程总共消耗了 16 GB 的 RAM。
- 每个工作人员消耗 300 MB 的 RAM 存储空间来完成一个请求。
- 为简单起见，我们假设 CPU 从 RAM 中获取数据。因此，缓存系统可确保所有必需的内容都可用于服务，而无需访问存储层。
- 每个 CPU 绑定请求需要 200 毫秒，而内存绑定请求需要 50 毫秒才能完成。

让我们对每种类型的请求进行计算。

**CPU 绑定：**用于计算 CPU 绑定请求的 RPS 的简单公式是：

$$
RPS(CPU) = Num(CPU) * \frac{1}{Task(time)}
$$
在此计算中，相关术语意义如下：

RPS(CPU): CPU绑定 RPS

Num(CPU): CPU线程数, 也成为硬件线程

Task(time): 完成每项任务所需的时间

按照本公式, RPS(CPU) 值为:
$$
RPS(CPU) = 72*\frac{1}{200ms}=360RPS
$$


从抽象的角度看, 我们可以将一秒钟想象成一个盒子，计算大盒子里可以容纳多少个小盒子（任务）-- 即一秒内CPU可以完成的任务数量。

直观来看, 更多的CPU/线程可以得到更高的 RPS。

**内存绑定请求：**用于计算内存绑定请求的公式为:
$$
RPS(memory)=\frac{RAM(size)}{Worker(memory)}*\frac{1}{Task(time)}
$$


相关术语含义如下：

RPS(memory): 内存绑定 RPS

RAM(size): RAM 总大小

Worker(memory): 单个请求任务消耗的时间

按照本公式, RPS(memory) 值为:
$$
RPS(memory)=\frac{240GB}{300MB}*\frac{1}{50ms}=16000RPS
$$


服务接收 CPU 绑定和内存绑定的请求。假设一半请求受 CPU 限制 另一半受内存限制的情况，我们总共可以处理 
$$
\frac{360}{2}+\frac{1600}{2}=8180RPS
$$
上述计算只是一个近似值，用于帮助您了解估算 RPS 所涉及的基本因素。

实际上，还有很多其他因素在起作用。

例如，如果数据在 RAM 中不可用，或者如果向数据库服务器发出请求，则执行磁盘查找需要延迟, 数据库查询需要延迟, 网络也存在延迟。

此外，查询的类型也很重要。

故障、代码错误、节点故障、停电、网络中断等等都是不可避免的因素。

正常的商业服务运行中, 各种类型的请求都会发生,

仅从 RAM 提供静态内容的服务器(前端)可能会处理多达 500k PRS 的数据.

另一方面 图像处理等计算密集型任务可能最多只允许 50RPS.

> **注意：**实际上，容量估算是一个难题，社区多年来一直在学习如何改进它。
>
> 监控系统密切关注我们基础架构的所有部分，以便在服务器过载时向我们发出早期警告。