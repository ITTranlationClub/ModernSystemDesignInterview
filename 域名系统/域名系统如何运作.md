# 域名系统如何运作

**本节目标** 掌握域名系统的详细工作原理。

本节, 我们将解决如下问题:

- 各种类型的 DNS 名称服务器是如何组成 DNS 层次结构的?
- 如何在 Internet 的不同级别执行缓存以减少 DNS 基础设施的查询负担？
- 为了提高系统稳健性, DNS 利用了那些分布式特性?

## DNS 层次结构

如前所述，DNS 不是接受请求和响应用户查询的单一服务器。它是一个完整的基础架构，分为不同的层次, 层次重包含响应用户DNS查询的 名称服务器。

DNS层次结构中主要有四种类型的服务器：

1. **DNS 解析器：**解析器启动查询序列并将请求转发到其他 DNS 名称服务器。通常，DNS 解析器位于用户网络的服务器下。且DNS 解析器可以通过缓存技术进一步满足用户的 DNS 查询(接下来会详细介绍). 这些服务器一般被称为 本地/默认服务器.
2. **根级名称服务器：**这些服务器接收来自本地服务器的请求。根名称服务器根据顶级域名解析域名, 将请求向下分发，例如`.com`、`.edu`、`.us`等。当用户请求`www.xxx.edu`的 IP 地址时，根级名称服务器将返回包含域 IP 地址的顶级域 (TLD) 服务器`.io`。
3. **顶级域 (TLD) 名称服务器：**这些服务器保存权威名称服务器的 IP 地址。查询方将得到属于该组织权威服务器的IP地址列表。
4. **权威名称服务器：**这些是最底层的 DNS 名称服务器，提供 Web 或应用程序服务器的 IP 地址。

![](https://cdn.jsdelivr.net/gh/gaoxiang15125/BlogImage@master/20230223143941.png)

###### 问题

对于域名 `www.XXX.edu` DNS服务是如何解析的? 从左到右还是从右到左?

> [!NOTE]
>
> 与从左到右处理的 UNIX 文件不同，DNS 名称是从右到左处理的。以` www.xxx.edu` 为例 ，解析器将首先解析`.edu`部分，然后解析`xxx`，依此类推。然而，在视觉上，DNS 层次结构可以被视为一棵树。

### 迭代与递归查询解析

DNS查询有两种执行方法：

1. **迭代：**本地服务器分别向根、TLD 和权威服务器请求 IP 地址。
2. **递归：**最终用户请求本地服务器。本地服务器进一步请求根 DNS 名称服务器。根名称服务器将请求转发给其他名称服务器。

![](https://cdn.jsdelivr.net/gh/gaoxiang15125/BlogImage@master/20230223144512.png)

> **注意：** 一般来说会使用迭代查询, 以减少DNS系统的查询负载

> !TIP
>
> 如今, 诸如 Google、Cloud Flare、OpenDNS 等公司都提供了第三方公共 DNS 解析器。有趣的是，这些公共 DNS 服务器的响应效率可能比本地 ISP DNS 服务器更快。

## 缓存

**缓存**是指临时存储请求频繁的资源记录. 记录是 DNS 数据库中的一个数据单元，完成名称到值的绑定. 缓存减少了用户请求的响应时间并减少了网络流量。当我们在不同的层次结构中使用缓存时，可以进一步减少 DNS 基础设施的大量查询负担。缓存可以在浏览器、操作系统、用户网络中的本地名称服务器或 ISP 的 DNS 解析器中实现。

![](https://cdn.jsdelivr.net/gh/gaoxiang15125/BlogImage@master/20230223150754.png)

- 用户请求访问一个URL, 浏览器缓存了域名到IP地址的映射, 直接访问对应IP资源
- 浏览器没有缓存域到IP地址的映射:
  - 查询操作系统映射缓存
  - 操作系统没有该域的映射
    - 查询本地DNS解析器缓存
    - 本地DNS解析器缓存没有该映射
      - 查询ISP缓存
      - ISP服务器没有该映射
        - DNS系统相应该请求, 并将结果逐步更新到各级缓存中

> **注意：**即使没有可用的缓存来解析用户的查询且必须访问 DNS 系统，缓存仍然是有益的。本地服务器或 ISP DNS 解析器可以缓存 TLD 服务器或权威服务器的 IP 地址，从而避免请求根级服务器。

## DNS -- 分布式系统特性

尽管 DNS 层次结构促进了我们今天所知的分布式 Internet，但它本身就是一个分布式系统。DNS 的分布式特性具有以下优点：

- 它避免成为单点故障 (SPOF)。
- 它实现了低查询延迟，因此用户可以从附近的服务器获得响应。
- 它在维护和更新或升级期间获得更高程度的灵活性。例如，如果一台 DNS 服务器停机或负载过重，另一台 DNS 服务器可以响应用户查询。

有 13 个逻辑根名称服务器（从字母**A**到**M**命名），其中许多实例遍布全球。这些服务器由 12 个不同的组织管理。

现在让我们来看看 DNS 如何具有可扩展性、可靠性和一致性。

### 高度可扩展

由于其分层性质，DNS 是一个高度可扩展的系统。13 个根级服务器的大约 1,000 个复制实例战略性地分布在世界各地，以处理用户查询。工作任务在 TLD 和根服务器之间分配以处理查询，最后由组织自己管理的权威服务器分配，以使整个系统正常工作。如上面的 DNS 层次结构树所示，不同的服务处理树的不同部分，从而实现系统的可扩展性和可管理性。

### 靠谱

使 DNS 成为可靠系统的三个主要原因：

1. **缓存：**缓存是在浏览器、操作系统和本地名称服务器中完成的，ISP DNS 解析器还维护着经常访问的服务的丰富缓存。即使某些 DNS 服务器暂时关闭，也可以提供缓存记录，使 DNS 成为可靠的系统。
2. **服务器复制：** DNS 具有系统地分布在全球各地的每个逻辑服务器的复制副本，以低延迟处理用户请求。冗余服务器提高了整个系统的可靠性。
3. **协议：**尽管许多客户端在不可靠的用户数据报协议 (UDP) 上使用 DNS，但 UDP 有其优势。UDP速度更快，因此提高了 DNS 性能。此外，Internet 服务的可靠性自其诞生以来已得到提高，因此 UDP 通常比 TCP 更受青睐。如果 DNS 解析器没有收到对前一个请求的回复，它可以重新发送 UDP 请求。这种请求-响应只需要一次往返，与 TCP 相比延迟更短，TCP 在数据交换之前需要三次握手。

指向思考

###### 问题

如果网络拥塞会怎样？DNS 是否应该继续使用 UDP？

隐藏答案

通常，DNS 使用 UDP。但是，当 DNS 的消息大小超过 512 字节的原始数据包大小时，DNS 可以使用 TCP。这是因为大数据包在拥塞的网络中更容易被损坏。DNS 始终使用 TCP 进行区域传输。出于隐私原因，一些客户更喜欢使用 DNS 而不是 TCP 来使用传输层安全性。

### 一致

DNS 使用各种协议在层次结构中的复制服务器之间更新和传输信息。DNS 在强一致性上做出妥协以实现高性能，因为与写入相比，数据更频繁地从 DNS 数据库读取。但是，DNS 提供最终一致性并延迟更新复制服务器上的记录。通常，更新 Internet 上 DNS 服务器上的记录可能需要几秒钟到三天的时间。在不同 DNS 集群之间传播信息所需的时间取决于 DNS 基础设施、更新的大小以及正在更新 DNS 树的哪一部分。

缓存也会影响一致性。由于权威服务器位于组织内，因此在组织的服务器发生故障的情况下，某些资源记录可能会在权威服务器上更新。因此，默认/本地和 ISP 服务器上的缓存记录可能已过时。为了缓解这个问题，每个缓存的记录都有一个称为**生存时间 (TTL) 的**过期时间。

指向思考

###### 问题

为了保持高可用，TTL值应该大还是小？

隐藏答案

为了保持高可用性，TTL 值应该很小。这是因为如果任何服务器或集群发生故障，组织可以立即更新资源记录。只有在 TTL 未过期时，用户才会遇到不可用的情况。但是，如果 TTL 很大，组织将更新其资源记录，而用户将不断 ping 很久以前就会崩溃的过时服务器。渴望高可用性的公司维持低至 120 秒的 TTL 值。因此，即使出现故障，最长停机时间也只有几分钟。

## 测试一下

让我们运行几个命令。单击终端以执行以下命令。在终端中复制以下命令以运行它们。研究命令的输出：

1. `nslookup www.google.com`
2. `dig www.google.com`

1号航站楼



终端



点击连接...

以下幻灯片突出显示了输出的一些重要`nslookup`方面`dig`。



nslookup www.google.com 的输出

**1**的2



让我们来看看输出的含义：

### 输出`nslookup` _

- 顾名思义`Non-authoritative answer`，就是非谷歌权威服务器提供的答案。它不在 Google 维护的权威名称服务器列表中。那么，答案从何而来？答案由配置为回复我们的 DNS 查询的第二、第三和第四手名称服务器提供——例如，我们的大学或办公室 DNS 解析器、我们的 ISP 名称服务器、我们的 ISP 的 ISP 名称服务器等。简而言之，它可以被视为 Google 权威名称服务器响应的缓存版本。如果我们尝试多个域名，我们会发现大多数时候我们都会收到缓存的响应。
- 如果我们多次运行相同的命令，我们将收到相同的 IP 地址列表，但每次的顺序不同。原因是 DNS 间接执行[负载平衡](https://www.educative.io/collection/page/10370001/4941429335392256/4521972679049216)。这是一个重要的术语，我们将在接下来的课程中熟悉它。

### 输出`dig` _

- 表示`Query time: 4 msec`从 DNS 服务器获得响应所需的时间。由于各种原因，这些数字在我们的案例中可能有所不同。
- `300`中的值表示*`ANSWER SECTION`*缓存在 DNS 解析器中保留的秒数。这意味着 Google 的 ADNS 将 TTL 值保持为五分钟（300 秒电子�6060300 *秒*的).

> **注意：**我们邀请您测试不同服务的 TTL 和查询时间，以加强您的理解。为此，您可以使用上述终端。

指向思考

###### 问题

如果我们需要 DNS 来告诉我们访问网站或服务的 IP，我们如何知道 DNS 解析器的 IP 地址？（这似乎是一个先有鸡还是先有蛋的问题！）

隐藏答案

最终用户的操作系统有配置文件（`/etc/resolv.conf`在 Linux 中），其中包含 DNS 解析器的 IP 地址，这反过来会为他们获取所有信息。（通常，DHCP 提供默认的 DNS 解析器 IP 地址以及其他配置。）终端系统请求 DNS 解析任何 DNS 查询。DNS 解析器安装了特殊软件以通过 DNS 基础结构解析查询。根服务器的IP地址在专用软件中。通常，Berkeley Internet Name Domain (BIND) 软件用于 DNS 解析器。InterNIC维护着 13[个](https://www.internic.net/domain/named.root)根服务器的更新列表。因此，我们通过为每个解析器提供根 DNS 服务器（其 IP 很少更改）的先验知识来打破鸡和蛋的问题。