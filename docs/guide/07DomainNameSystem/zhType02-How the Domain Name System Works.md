# DNS如何工作

了解域名系统的详细工作原理。

通过本课程，我们将回答以下问题：

- 如何使用不同类型的DNS名称服务器形成DNS层次结构？
- 在互联网的不同级别上如何进行缓存以减少DNS基础设施的查询负担？
- DNS基础设施的分布式本质如何帮助其健壮性？

让我们开始吧。

## DNS层次结构

如前所述，DNS不是单个服务器，它接受请求并响应用户查询。它是一个完整的基础设施，具有不同层次的名称服务器。

DNS层次结构中主要有四种类型的服务器：

1. **DNS解析器：** 解析器启动查询序列并将请求转发给其他DNS名称服务器。通常，DNS解析器位于用户网络的范围内。但是，DNS解析器还可以通过缓存技术响应用户的DNS查询，稍后我们将详细介绍。这些服务器也可以称为本地或默认服务器。

2. **根级别名称服务器：** 这些服务器收到本地服务器的请求。根名称服务器基于顶级域名（如`.com`、`.edu`、`.us`等）维护名称服务器。例如，当用户请求`educative.io`的IP地址时，根级别名称服务器将返回一个包含`.io`域的IP地址的顶级域名（TLD）服务器列表。

3. **顶级域名（TLD）名称服务器：** 这些服务器持有授权名称服务器的IP地址。查询方将获取属于组织的授权服务器的IP地址列表。

4. **授权名称服务器：** 这些是组织的DNS名称服务器，它们提供Web或应用程序服务器的IP地址。

![DNS层次结构以解析域名/主机名](/img/07-Domain Name System/QQ截图20230406205130.png)

域名/主机名解析的DNS层次结构

思考题

###### 问题

DNS名称如何处理？例如，`educative.io`将从左到右或从右到左处理？

隐藏答案

与UNIX文件不同，DNS名称从右到左处理。对于`educative.io`，解析器将首先解析`.io`部分，然后是`educative`等等。

视觉上，DNS层次结构可以看作是一棵树。


### 迭代查询和递归查询解决方案比较

有两种方法可以执行DNS查询：

1. **迭代：** 本地服务器向根服务器、TLD服务器和授权服务器请求IP地址。

2. **递归：** 终端用户向本地服务器请求。本地服务器进一步请求DNS根名称服务器。根名称服务器将请求转发给其他名称服务器。

在下面的插图（图左）中，本地/ISP服务器的DNS查询解决方案是迭代的：

![递归查询和迭代查询](/img/07-Domain Name System/QQ截图20230406205217.png)

迭代查找和递归查找

> **注意：** 通常，迭代查询优先于递归查询，以减少DNS基础设施的查询负载。

现在，我们会发现许多谷歌、Cloudflare、OpenDNS等提供的第三方公共DNS解析器。有趣的事实是这些公共DNS服务器可能会比本地ISP DNS设施提供更快的响应。

## 缓存

**缓存**是指存储频繁请求的“资源记录”的临时存储。**记录**是DNS数据库中的数据单元，显示名称与值的绑定。缓存可减少响应用户的时间，并减少网络流量。当我们在不同层次上使用缓存时，它可以减轻DNS基础设施的查询负担。缓存可以在浏览器、操作系统、用户网络中的本地名称服务器或ISP DNS解析器中实现。

下面的幻灯片演示了DNS缓存的功能：

![DNS缓存](/img/07-Domain Name System/QQ截图20230413204931.png)用户请求访问网址时，浏览器已经缓存了域名到IP地址的映射关系！[QQ截图20230413204948](/img/07-Domain Name System/QQ截图20230413204948.png)如果浏览器没有缓存域名到IP地址的映射关系，接下来可以找到该映射关系的分层结构是操作系统！[QQ截图20230413205001](/img/07-Domain Name System/QQ截图20230413205001.png)如果操作系统没有该映射关系，本地DNS解析器可以有缓存响应！[QQ截图20230413205012](/img/07-Domain Name System/QQ截图20230413205012.png)如果本地DNS解析器没有映射关系，ISP可以有缓存响应！[QQ截图20230413205028](/img/07-Domain Name System/QQ截图20230413205028.png)最后，DNS基础设施将响应IP！[QQ截图20230413205043](/img/07-Domain Name System/QQ截图20230413205043.png)缓存将在每个分层结构中更新！[QQ截图20230413205110](/img/07-Domain Name System/QQ截图20230413205110.png)浏览器现在已经更新了缓存，因此用户请求将在本地得到服务。> **注意：**即使没有可用的缓存来解决用户的查询并且必须访问DNS基础设施，缓存仍然可以提供好处。本地服务器或ISP DNS解析器可以缓存顶级域服务器或授权服务器的IP地址，避免请求根级服务器。## DNS作为分布式系统虽然DNS层次结构支持我们今天所知道的分布式互联网，但它本身是分布式系统。DNS分布式性质具有以下优点：- 它避免成为单点故障（SPOF）。- 可以实现低查询延迟，使用户可以从附近的服务器获得响应。- 在维护、更新或升级期间具有更高的灵活性。例如，如果一个DNS服务器宕机或负荷过重，另一个DNS服务器可以响应用户查询。目前有13个逻辑根名称服务器（命名为字母A到M），在全球范围内分布着许多实例。这些服务器由12个不同的组织管理。现在让我们来看看DNS如何是可伸缩的、可靠的和一致的。###高度可伸缩由于其层次结构特点，DNS是一个高度可伸缩的系统。大约有1,000个复制的13个顶级服务器实例在全球范围内分布，以处理用户查询。工作任务在TLD和根服务器之间分配以处理查询，最终由组织本身管理的授权服务器来使整个系统运行。如上所示的DNS层次结构树中，不同的服务处理不同的树部分，实现了系统的可伸缩性和可管理性。### 可靠DNS是一个可靠的系统，有三个主要原因：1. **缓存：**在浏览器、操作系统和本地名称服务器以及ISP DNS解析器中进行缓存，经常访问的服务也保持有丰富的缓存。即使某些DNS服务器暂时宕机，也可以提供缓存记录以使DNS成为可靠的系统。2. **服务器复制：** DNS在全球范围内 systematically 复制每个逻辑服务器的副本，以以低延迟响应用户请求。冗余服务器提高了整个系统的可靠性。3. **协议：**尽管许多客户端使用DNS通过不可靠的用户数据报协议（UDP），但UDP具有其优点。UDP速度更快，因此提高了DNS性能。此外，自其创立以来，因特网服务的可靠性得到了改善，因此通常比TCP更受欢迎。DNS解析器可以在没有以前得到答复的情况下重新发送UDP请求。此请求-响应只需要一次来回，提供比TCP更短的延迟，TCP在数据交换之前需要三次握手。值得思考###### 问题如果网络拥塞会发生什么？DNS是否应继续使用UDP？隐藏答案通常情况下，DNS使用UDP。但是，当其消息大小超过512字节的原始数据包大小时，DNS可以使用TCP。这是因为大尺寸数据包更容易在拥塞的网络中受损。DNS始终使用TCP进行区域传输。有些客户端出于隐私原因更喜欢使用DNS over TCP来实现传输层安全。

### 一致性

DNS使用各种协议在层次结构中的复制服务器之间更新和传输信息。为了实现高性能，DNS在强一致性方面做出了让步，因为与写入相比，数据经常从DNS数据库中读取。然而，DNS提供最终一致性，并懒惰地在复制的服务器上更新记录。通常，更新DNS服务器上的记录可能需要几秒钟到三天的时间。在不同的DNS集群之间传播信息所需的时间取决于DNS基础架构，更新的大小以及正在更新的DNS树的哪个部分。

由于缓存，一致性可能会受到影响。由于权威服务器位于组织内部，因此可能会在组织的权威服务器上更新某些资源记录，以防组织的服务器故障。因此，默认/本地和ISP服务器上的缓存记录可能已过时。为了解决这个问题，每个缓存记录都有一个到期时间，称为**生存时间（TTL）**。

### 思考一下

###### 问题

为了保持高可用性，TTL值应该很大还是很小？

隐藏答案

为了保持高可用性，TTL值应该很小。这是因为如果任何服务器或集群故障，组织可以立即更新资源记录。用户只有在TTL未过期的时间内才会遇到不可用性。但是，如果TTL很大，组织将更新其资源记录，而用户将继续将已经崩溃很久的过时服务器作为目标。渴望高可用性的公司将TTL值保持在120秒左右。因此，即使出现故障，最长的停机时间也只有几分钟。

## 测试一下

让我们运行几个命令。点击终端执行以下命令。复制以下命令到终端中以运行它们。研究命令的输出：

1. `nslookup www.google.com`
2. `dig www.google.com`

下面的幻灯片重点介绍了`nslookup`和`dig`输出的一些重要方面。

![QQ截图20230406205439](/img/07-Domain Name System/QQ截图20230406205439.png)

输出nslookup www.google.com

![QQ截图20230406205451](/img/07-Domain Name System/QQ截图20230406205451.png)

输出dig www.google.com

让我们解释一下输出的含义：

### `nslookup`输出

-“非权威答案”顾名思义，是由不是Google权威服务器的服务器提供的答案。它没有列在Google维护的权威名称服务器列表中。那么答案来自哪里？答案是由二手，三手和四手名称服务器提供的，它们配置为回复我们的DNS查询。例如，我们的大学或办公室DNS解析器，我们的ISP名称服务器，我们的ISP的ISP名称服务器等。简而言之，它可以被认为是Google权威名称服务器响应的缓存版本。如果我们尝试多个域名，我们会意识到大多数时候我们会收到缓存的响应。

-如果我们多次运行同一命令，则每次都会以不同的顺序列出相同的IP地址列表。原因是DNS间接地执行`负载平衡`。这是一个我们将在接下来的课程中熟悉的重要术语。

### `dig`输出

```
ANSWER部分中的值300 表示DNS解析器中保留缓存的秒数。这意味着Google的ADNS保持五分钟的TTL值。
````Query time: 4 msec`表示从DNS服务器获取响应所需的时间。由于各种原因，这些数字在我们的情况下可能有所不同。 

> **注意：**我们邀请您测试不同服务的TTL和查询时间，以加强您的理解。您可以使用以上终端进行此操作。

# 思考问题

###### 问题

如果我们需要DNS告诉我们可以访问网站或服务的IP地址，我们将如何知道DNS解析器的IP地址？（这似乎像一个鸡和蛋的问题！）

隐藏答案

终端用户的操作系统具有包含DNS解析器IP地址的配置文件（在Linux中为`/etc/resolv.conf`），这些地址获取了它们所有的信息。（通常，DHCP提供默认的DNS解析器IP地址和其他配置。）最终系统会请求DNS解析任何DNS查询。DNS解析器有特殊的软件安装，通过DNS基础设施来解析查询。根服务器的IP地址在这个特殊软件中。通常，在DNS解析器上使用Berkeley互联网名称域（BIND）软件。`InterNIC`维护更新的13个根服务器列表。因此，我们通过向每个解析器提供关于根DNS服务器（它们的IP地址很少更改）的先验知识来打破鸡和蛋的问题。