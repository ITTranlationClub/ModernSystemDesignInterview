# CDN深入调查：第一部分

了解CDN中的推拉模型和动态内容缓存优化。

在本课中，我们将深入探讨在前几节中提到的CDN模型和多层级/分层CDN架构等概念。我们还将介绍一些新的概念，包括动态内容缓存优化以及在CDN中发现附近代理服务器的各种技术。

## CDN中的内容缓存策略

确定要缓存的内容对于提供最新和流行的网络内容非常重要。为了确保及时更新，使用两种CDN分类从源服务器获取内容。

### 推CDN

在推CDN模型中，内容会自动从源服务器发送到CDN代理服务器。将内容提供给CDN代理服务器是内容提供者的责任。推CDN适用于静态内容传递，其中源服务器决定使用CDN向用户提供哪些内容。根据内容的流行程度，将内容推送到各种位置的代理服务器。如果内容快速更改，则推模型可能无法跟上并将进行冗余内容推送。

![QQ截图20230408185159](/img/11-Content Delivery Network (CDN)/QQ截图20230408185159.png)

推送内容到PoPs

### 拉CDN

在拉CDN模型中，当用户请求时，CDN会从源服务器拉取不可用的数据。代理服务器会保留文件一段时间，然后在不再请求时将其从缓存中删除，以平衡容量和成本。

当用户在拉CDN模型中请求网络内容时，CDN本身负责从源服务器拉取请求的内容并向用户提供服务。因此，这种类型的CDN更适合提供动态内容。

![QQ截图20230408185208](/img/11-Content Delivery Network (CDN)/QQ截图20230408185208.png)

从源服务器拉取内容并缓存在CDN PoPs中

如前所述，推CDN主要用于提供静态内容。由于静态内容在较长时间内向广泛的用户提供服务，因此推CDN方案比拉CDN维护更多的副本，从而提高可用性。另一方面，拉CDN适合频繁更改的内容和高流量负载。低存储消耗是拉CDN的主要优势。

> 注意：大多数内容提供者使用拉和推CDN缓存方法以获得两者的好处。

## 动态内容缓存优化

由于动态内容经常更改，最好进行最佳缓存。本节将涵盖频繁更改的内容的优化。

某些动态内容创建需要在代理服务器上执行脚本，而不是在源服务器上运行。可以使用各种参数生成动态数据，如果在代理服务器上执行，则可能很有益。例如，我们可以根据用户位置、某个位置的时间、特定于位置的第三方API（例如天气API）等生成动态内容。因此，在代理服务器而不是源服务器上运行脚本是最佳的选择。

为了减少源服务器和代理服务器之间的通信以及代理服务器的存储要求，使用压缩技术也很有用。例如，Cloudflare使用Railgun来压缩动态内容。

另一种流行的动态数据压缩方法是**边缘端包含（ESI）**标记语言。通常，一小部分网页内容会在某段时间内更改。这意味着每次小变化都获取完整的网页包含许多冗余数据。为了解决这种性能损失，ESI指定了哪里更改了内容，以便可以缓存网页的其余内容。它在CDN边缘服务器或客户端浏览器上组装动态内容。ESI目前尚未由万维网联盟（W3C）标准化，但许多CDN提供商使用它。> **注意**: **动态自适应流媒体传输协议（Dynamic Adaptive Streaming one HTTP，DASH）** 使用一个包含具有不同分辨率视频 URI 的清单文件，以便客户端根据当前网络和终端节点条件请求合适的视频。Netflix 使用具有 URL 中字节范围的专有 DASH 版本以进一步优化内容请求和传递。## 多层 CDN 架构内容提供者通过 CDN 向大量客户端发送内容。同时向所有 CDN 代理服务器分发数据的任务具有挑战性，会对源服务器造成重负。CDN 遵循树状结构，以减轻源服务器的数据分发过程。边缘代理服务器拥有一些属于同一层次结构的对等服务器。这组服务器从树的父节点接收数据，最终从源服务器接收数据。数据通过树中的不同路径从源服务器复制到代理服务器。数据分发的树状结构允许我们通过向树中添加更多服务器节点来扩展系统以适应不断增加的用户数量。它还减轻了源服务器的数据分发负担。CDN 通常具有一到两个代理服务器层（缓存）。以下插图显示了两个代理服务器层：![QQ截图20230408185221](/img/11-Content Delivery Network (CDN)/QQ截图20230408185221.png)CDN 代理服务器之间的数据分发当 CDN 的新代理服务器进入树时，它会请求控制核心，该核心维护有关 CDN 中所有代理服务器的信息，并提供具有配置数据的初始内容。研究表明，许多内容具有长尾分布。这意味着，在某些时候，只有一小部分内容非常流行，然后我们有一个不太流行的长尾。在这里，可以使用多层缓存来处理长尾内容。![QQ截图20230408185231](/img/11-Content Delivery Network (CDN)/QQ截图20230408185231.png)许多类型的数据显示出长尾现象要考虑的问题###### 问题如果子代理服务器或父代理服务器失败或源服务器失败会发生什么？隐藏答案每个 PoP 包含一组 CDN 代理服务器。当任何子代理服务器由于任何故障而停止工作时，DNS 可以将客户端路由到另一个子级代理服务器。每个子代理服务器都知道许多上层父服务器，如果其中一个失败，它可以转到另一个。源服务器是一组具有热备份的服务器，并且内容在复制存储中。如果任何源服务器发生故障，则其他服务器将承担负载。现在我们已经知道了如何将内容从源服务器分发到 CDN 的所有代理服务器，我们还应该了解用户如何使用这些代理服务器以更有效地获取数据。我们将在本课程的后续章节中讨论如何选择最近的代理服务器并定位 CDN。## 找到最近的代理服务器来获取数据对于用户从最近的代理服务器获取数据非常重要，因为 CDN 的目标是将数据靠近用户以减少用户感知的延迟。然而，问题仍然存在，即全球用户如何从最近的代理服务器请求数据。本节的目标是回答这个问题。### 影响代理服务器近程程度的两个重要因素以下两个因素与找到用户最近的代理服务器有关：- 用户和代理服务器之间的网络距离很重要。这是以下两件事的函数： - 第一个是网络路径的长度。- 第二个是沿网络路径的容量（带宽数）限制。带宽最高，网络路径最短的是用户的最近代理服务器。这条路径有助于用户更快地下载内容。- **请求负载**指代代理服务器在任何时刻处理的负载。如果一组代理服务器超载，请求路由系统应将请求转发到负载更小的位置。这个操作平衡了代理服务器负载，因此减少了响应延迟。让我们看一下可以用来将用户路由到最近代理服务器的技术。### DNS 重定向在典型的 DNS 解析中，我们使用 DNS 系统针对一个人类可读名称获取 IP。然而，DNS 可以向客户端返回另一个 URI（而非 IP）。这种机制称为 **DNS 重定向**。内容提供商可以使用 DNS 重定向将客户端发送到特定的 CDN。例如，如果客户端尝试解析一个名称包含“视频”的名称，权威 DNS 服务器提供另一个 URL（例如 *c*d*n*.*x*y*z*.*c*o*m*）。客户端进行另一次 DNS 解析，CDN 的权威 DNS 提供一个适当 CDN 代理服务器的 IP 地址，以获取所需的内容。根据用户的位置，DNS 的响应可能会不同。让我们看一下下面的幻灯片来理解 DNS 重定向是如何工作的：![QQ截图20230408185244](/img/11-Content Delivery Network (CDN)/QQ截图20230408185244.png)代理服务器交付所请求的视频> **注意**：最近的代理服务器不一定是地理位置最接近的服务器。它可能是，但不仅仅是地理位置的问题。其他因素如网络距离、带宽和已经存在于该路由上的流量负载也很重要。DNS 重定向方法有两个步骤：1. 在第一步中，将客户端映射到适当的网络位置。2. 在第二步中，将负载分布到该位置的代理服务器上以平衡代理服务器之间的负载（有关详细信息，请参见 [DNS](https://www.educative.io/collection/page/10370001/4941429335392256/5728619204182016) 和 [负载均衡器](https://www.educative.io/collection/page/10370001/4941429335392256/4521972679049216) 构建块）。DNS 重定向同时考虑了这两个重要因素——网络距离和请求负载，从而减少了向代理服务器的延迟。为了将客户端从群集中的一个机器转移到另一个机器，第二步中的 DNS 回应会给出短 TTL，以便客户端在短时间后重复解析。DNS 通过在硬件故障和网络拥塞的情况下负载平衡流量、采用智能容错并在多个数据中心维护服务器来路由请求以持续提供内容，从而实现良好的可靠性和性能。由于代理服务器的负载随时间而变化，内容提供商需要适当更改 DNS，以使 DNS 重定向生效。许多 CDN 提供商像 Akamai 在其路由系统中使用 DNS 重定向。### Anycast**Anycast**是一种路由方法，在多个位置的边缘服务器共享相同的单个 IP 地址。它采用 **边界网关协议（BGP）** 根据互联网的自然网络流量路由客户端。CDN 提供商可以使用 Anycast 机制，以使客户端指向最近的代理服务器以获取内容。### 客户端多路复用**客户端多路复用**涉及向客户端发送候选服务器列表。然后，客户端从列表中选择一个服务器向其发送请求。这种方法并不高效，因为客户端缺乏选择最适合其请求的服务器的总体信息。这可能会导致向已经加载的服务器发送请求并遇到更高的访问延迟。### HTTP 重定向**HTTP 重定向**是所有方法中最简单的方法。通过此方案，客户端从源服务器请求内容。源服务器用 HTTP 协议响应，通过内容的 URL 重定向用户。下面是Facebook提供的HTML片段示例。如第8行所示，用户被重定向到CDN以下载Facebook的标志： 

```html
<!–– 以下代码来自Facebook。––>
<div class="fb_content clearfix " id="content" role="main"> 
   <div>  
      <div class="_8esj _95k9 _8esf _8opv _8f3m _8ilg _8icx _8op_ _95ka">   
         <div class="_8esk">    
            <div class="_8esl">     
               <div class="_8ice">      
                  <img class="fb_logo" src="https://static.xx.fbcdn.net/rsrc.php/y8/r/dF5SId3UHWd.svg">      
               </div>     
               <h2 class="_8eso">Facebook helps you connect and share with the people in your life.</h2>    
            </div>   
         </div>  
      </div> 
   </div>
</div>
```
下面是包含重定向URL的HTML示例。

在下一课中，我们将讨论内容一致性和代理服务器在CDN中的部署的不同细节。