---
typora-root-url: ..
---

# 认识域名系统的工作原理

了解域名系统的详细工作原理。在本课程中，我们将回答以下问题：

- 如何使用各种类型的DNS名称服务器形成DNS层次结构？
- 在互联网的不同级别上如何执行缓存以减少对DNS基础架构的查询负担？
- DNS基础架构的分布式特性如何帮助其鲁棒性？

让我们开始。

## DNS层次结构

如前所述，DNS不是单个服务器，它接受请求并响应用户查询的。它是一个完整的基础架构，具有不同层次的命名服务器。

在DNS层次结构中，主要有四种类型的服务器：

1. **DNS解析器：** 解析器启动查询序列，并将请求转发给其他DNS名称服务器。通常，DNS解析器位于用户网络的前提下。然而，DNS解析器也可以通过缓存技术来满足用户的DNS查询，我们很快就会看到。这些服务器也可以被称为本地或默认服务器。

2. **根级别名称服务器：** 这些服务器接收来自本地服务器的请求。根名称服务器维护基于顶级域名的名称服务器，例如`.com`、`.edu`、`.us`等。例如，当用户请求educative.io 的IP地址时，根级别名称服务器将返回持有`.io`域的IP地址的顶级域名（TLD）服务器列表。

3. **顶级域名（TLD）名称服务器：** 这些服务器持有权威名称服务器的IP地址。查询方将获取一个属于组织的权威服务器的IP地址列表。

4. **权威名称服务器：** 这是组织的DNS名称服务器，它提供Web或应用程序服务器的IP地址。

![QQ截图20230406205130](/img/07-Domain Name System/QQ截图20230406205130.png)

解析域名/主机名的DNS层次结构

思考问题

问：DNS名称是如何处理的？例如，[educative.io](http://educative.io/)是从左到右还是从右到左处理的？

隐藏答案

与UNIX文件不同，UNIX文件是从左向右处理的，DNS名称是从右向左处理的。在[educative.io](http://educative.io/)的情况下，解析器将首先解析`.io`部分，然后解析`educative`等等。然而，从可视角度来看，DNS层次结构可以被视为一棵树。

### 迭代查询和递归查询

执行DNS查询有两种方法：

1. **迭代：** 本地服务器请求根、TLD和权威服务器以获取IP地址。

2. **递归：** 最终用户请求本地服务器。本地服务器进一步请求根DNS名称服务器。根名称服务器将请求转发到其他名称服务器。

在下图中（左侧），从本地/ISP服务器的角度来看，DNS查询解析是迭代的：

![QQ截图20230406205217](/img/07-Domain Name System/QQ截图20230406205217.png)

迭代查询和递归查询

> **注意：** 通常，迭代查询比递归查询更受欢迎，以减少对DNS基础架构的查询负担。

如今，我们会找到许多第三方公共DNS解析器，由Google、Cloudflare、OpenDNS等提供。有意思的是，这些公共DNS服务器可能比本地ISP DNS设施提供更快的响应。

## 缓存

**缓存**是指临时存储经常请求的`资源记录`。一个记录是DNS数据库中的一个数据单元，它显示名称到值的绑定。缓存减少了响应时间和网络流量。当我们在不同的层次上使用缓存时，可以减少很多对DNS基础架构的查询负担。 缓存可以在浏览器、操作系统、用户网络中的本地名称服务器或ISP的DNS解析器中进行实现。下面的幻灯片演示了DNS中缓存的强大功能：![QQ截图20230406205301](/img/07-Domain Name System/QQ截图20230406205301.png)![搜狗截图20230406205330](/img/07-Domain Name System/搜狗截图20230406205330.png)

> **注意：**即使没有可用的缓存来解析用户的查询并且必须访问DNS基础设施，缓存仍然有益。本地服务器或ISP DNS解析器可以缓存TLD服务器或权威服务器的IP地址，避免请求根级别服务器。

## DNS作为分布式系统
虽然DNS层次结构促进了我们今天所知的分布式互联网，但它本身就是分布式系统。DNS的分布性具有以下优点：- 避免成为单点故障（SPOF）。- 实现低查询延迟，因此用户可以从附近的服务器获取响应。- 在维护、更新或升级期间获得更高的灵活性。例如，如果一个DNS服务器崩溃或负担过重，另一个DNS服务器可以响应用户的查询。有13个逻辑根名称服务器（以字母**A**到**M**命名），分散在全球范围内的许多实例中。这些服务器由12个不同的组织管理。接下来让我们来看一下DNS如何实现可扩展性、可靠性和一致性。### 高度可扩展由于其分层结构，DNS是一个高度可扩展的系统。大约有1,000个复制的13个根层服务器实例在全球范围内分布，以处理用户的查询。工作人员被分配在TLD和根服务器之间来处理查询，最后是由组织自己管理的权威服务器来使整个系统运作。如上所示的DNS层次树中，不同的服务处理不同部分的树，实现了系统的可扩展性和可管理性。### 可靠主要有三个原因使DNS成为可靠的系统：1. **缓存：**缓存在浏览器、操作系统和本地名称服务器中进行，并且ISP DNS解析器还维护频繁访问的服务的丰富缓存。即使某些DNS服务器暂时关闭，缓存记录也可以被提供，以使DNS成为可靠的系统。2. **服务器复制：**DNS在全球范围内系统地分布着每个逻辑服务器的副本，以在低延迟、响应用户请求。冗余服务器提高了整个系统的可靠性。3. **协议：**虽然许多客户端使用不可靠的用户数据报协议（UDP）进行DNS，但UDP具有其优点。UDP更快，因此提高了DNS的性能。此外，自其问世以来，互联网服务的可靠性有所提高，因此通常更喜欢UDP而不是TCP。如果DNS解析器没有收到之前的UDP请求的回复，它可以重新发送UDP请求。这个请求-响应只需要一次往返，提供了比TCP更短的延迟，TCP在数据交换之前需要三次握手。思考问题###### 问题如果网络拥塞会发生什么？ DNS是否应继续使用UDP？隐藏答案通常，DNS使用UDP。但是，当消息大小超过512字节的原始数据包大小时，DNS可以使用TCP。这是因为大尺寸数据包更容易在拥挤的网络中损坏。DNS始终使用TCP进行区域传输。一些客户端更喜欢使用DNS over TCP来使用传输层安全性，以保护隐私。### 一致DNS使用多种协议在层次结构中的复制服务器之间更新和传输信息。DNS在强一致性方面妥协以实现高性能，因为与写入相比，频繁地从DNS数据库中读取数据。然而，DNS提供最终一致性，并懒惰地在复制服务器上更新记录。通常，在互联网上更新DNS服务器上的记录需要从几秒钟到三天的时间。信息在不同DNS集群之间传播所需的时间取决于DNS基础架构、更新的大小以及正在更新的DNS树的哪部分。因为缓存的原因，一致性也可能会受到影响。由于授权服务器位于组织内部，因此在组织出现服务器故障的情况下，可能会更新某些资源记录的授权服务器。因此，在默认/本地和ISP服务器上缓存的记录可能已经过时。为了缓解这个问题，每个缓存记录都有一个名为“生存时间（TTL）”的过期时间。思考问题问：为了保持高可用性，TTL值应该是大还是小？隐藏答案为了保持高可用性，TTL值应该很小。这是因为如果任何服务器或集群失败，组织可以立即更新资源记录。用户将只在TTL未过期的时间内经历不可用性。然而，如果TTL值很大，组织将更新其资源记录，而用户将继续ping已经崩溃了很久的过时服务器。渴望高可用性的公司将TTL值保持在120秒左右。因此，即使发生故障，最大的停机时间也只有几分钟。试一试让我们运行几个命令。单击终端以执行以下命令。复制以下命令到终端以运行它们。学习命令的输出：1. nslookupwww.google.com2. digwww.google.com以下幻灯片强调了nslookup和dig输出的一些重要方面。！[QQ截图20230406205439]（/img/07-Domain Name System/QQ截图20230406205439.png）！[QQ截图20230406205451]（../img/07-Domain Name System/QQ截图20230406205451.png）让我们仔细看一下输出的含义：###nslookup输出-“非授权回答”顾名思义，是由Google的授权服务器之外的服务器提供的答案。它不在谷歌维护的权威名称服务器列表中。那答案从哪来？答案由配置为回复我们的DNS查询的第二、第三和第四手名称服务器提供-例如，我们的大学或办公室DNS解析器、我们的ISP名称服务器、我们的ISP的ISP名称服务器等等。简而言之，它可以被认为是Google权威名称服务器响应的缓存版本。如果我们尝试多个域名，我们会意识到大多数时间我们会收到缓存的响应。-如果我们多次运行相同的命令，我们将收到相同的IP地址列表，但每次顺序都不同。原因是DNS间接地执行负载平衡。这是一个重要的术语，我们将在接下来的课程中熟悉。###dig输出-“查询时间：4毫秒”表示从DNS服务器获取响应所需的时间。由于各种原因，这些数字可能在我们的情况下不同。-“ANSWER SECTION”中的“300”值表示DNS解析器中维护缓存的秒数。这意味着Google的ADNS保留了五分钟（300秒）的TTL值。> **注意：**我们邀请您测试不同的服务以了解其TTL和查询时间，以增强您的理解。您可以使用上面的终端进行此操作。思考问题问：为了保持高可用性，TTL值应该是大还是小？如果我们需要DNS告诉我们如何到达一个网站或服务的IP地址，我们该如何知道DNS解析器的IP地址？（这似乎是一个先有鸡还是先有蛋的问题！）

答案：最终用户的操作系统有配置文件（Linux下的`/etc/resolv.conf`），其中包含DNS解析器的IP地址，进而为它们获取所有的信息。（通常，DHCP会提供默认的DNS解析器IP地址以及其他配置。）终端系统请求任何DNS查询的DNS解析。DNS解析器安装有特殊的软件，通过DNS基础设施来解决查询。根服务器的IP地址在特殊软件中。通常，DNS解析器使用伯克利因特网名称域（BIND）软件。 [InterNIC](https://www.internic.net/domain/named.root)维护13个根服务器的更新列表。因此，我们通过向每个解析器提供关于根DNS服务器的先验知识（其IP地址很少更改）打破了先有鸡还是先有蛋的问题。