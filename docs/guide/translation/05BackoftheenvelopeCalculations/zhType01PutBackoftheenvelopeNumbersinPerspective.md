# 将草稿式计算合理化

学习如何在草稿式计算中使用适当的数字。

## 为什么要使用草稿式计算？

分布式系统由通过网络连接的计算节点组成。有各种各样的计算节点，它们可以以多种不同的方式连接在一起。草稿式计算有助于我们忽略系统的细节（至少在设计层面），并关注更重要的方面。

草稿式计算的一些示例可能包括：

- 服务器可以支持的并发TCP连接数。
- 网站、数据库或缓存服务器可以处理的每秒请求数（RPS）。
- 服务的存储需求。

对此类计算选择不合理的数字可能会导致不完善的设计。由于在许多设计问题中我们需要良好的估计，因此我们将在本课中详细讨论所有相关概念。这些概念包括：

- 数据中心服务器的类型。
- 不同组件的实际访问延迟。
- 服务器可以处理的RPS的估算。
- 带宽、服务器和存储估算的实例。

## 数据中心服务器的类型

**数据中心** 没有单一类型的服务器。企业解决方案使用通用硬件来节省成本并开发可扩展的解决方案。以下是在数据中心中通常用于处理不同工作负载的服务器类型。

![QQ截图20230406174803](/img/05-Back-of-the-envelope Calculations/QQ截图20230406174803.png)

服务器的Web、应用和存储层所需资源的近似值。 Y轴是一个分类轴，具有低、中和高数据点。

### Web服务器

为了实现可伸缩性，Web服务器与应用服务器解耦。 **Web服务器** 是在负载均衡器之后的第一个接触点。数据中心中有许多架用于处理来自客户端的API调用的Web服务器。根据所提供的服务，Web服务器中的内存和存储资源可以是小到中等。但是，这些服务器需要良好的计算资源。例如，Facebook使用了配备32 GB内存和500 GB存储空间的Web服务器。但是针对其高端计算需求，它与英特尔合作构建了定制的16核处理器。

> **注意**: 本课中引用的许多数字来自Facebook于2011年开源的数据中心设计。由于自2004年起Moore定律的性能放缓，因此这些数字并不过时。

### 应用服务器

**应用服务器** 运行核心应用软件和业务逻辑。Web服务器和应用服务器之间的区别有些模糊。应用服务器主要提供动态内容，而Web服务器主要向客户端提供静态内容，客户端通常是Web浏览器。它们可以需要广泛的计算和存储资源。存储资源可以是易失性和非易失性的。Facebook使用了RAM高达256GB的应用服务器和两种类型的存储介质 – 传统旋转盘和容量高达6.5TB的Flash。

### 存储服务器

随着互联网用户数量的爆炸性增长，巨型服务存储的数据量大大增加。此外，各种类型的数据现在存储在不同的存储单元中。例如，YouTube使用以下数据存储：

1. 用于编码视频的 **Blob存储** 。
2. 一个 **临时处理队列存储** 可以容纳每天上传到YouTube以进行处理的几百个小时的视频内容。
3. 用于存储大量视频缩略图的专门存储叫做 **Bigtable** 。
4. 用于用户和视频元数据（评论，喜欢，用户频道等）的 **关系数据库管理系统（RDBMS）** 。其他数据存储仍然被用于分析，例如Hadoop的HDFS。存储服务器主要包括结构化（例如SQL）和非结构化（NoSQL）数据管理系统。回到Facebook的例子，我们知道他们使用了储存容量高达120 TB的服务器。随着使用的服务器数量增加，Facebook能够容纳exabytes的存储。一个exabyte是10的18次方字节。按照惯例，我们以10进制而不是2进制来衡量存储和网络带宽。然而，这些服务器的RAM只有32 GB。
> **注意：** 上述描述的服务器并不是数据中心中唯一的服务器类型。组织还需要服务器来提供配置、监视、负载平衡、分析、会计、缓存等服务。
Facebook公开的数字现在已经过时。在下表中，我们描述了今天数据中心中可以使用的服务器的性能规格：

## 典型服务器规格
| 组件 | 数量 |
| ---------- | ------------------- |
| 插槽数量 | 2 |
| 处理器 | Intel Xeon X2686 |
| 核数 | 36核（72线程） |
| 内存 | 256 GB |
| 缓存（L3） | 45 MB |
| 存储容量 | 15 TB |

上述数字受到亚马逊裸金属服务器的启发，但是支持更高RAM（高达8 TB）、磁盘存储（长达24个硬盘，每个硬盘高达20 TB，约为2021年）和缓存内存（高达120 MB）的机器可能会更强大或更不强大。

## 需要牢记的标准数字
为了开展服务规划和实施等工作，需要付出大量的努力。但是在没有了解机器可以处理的工作负载类型的基本知识的情况下，这种规划是不可能的。延迟在决定机器可以处理的工作负载量方面发挥了重要作用。下表展示了一些系统设计者应该知道的重要数字，以便进行资源评估。

## 重要延迟时间
| 组件 | 时间（纳秒） |
| ----------- | ------------------- |
| L1高速缓存 | 0.9 |
| L2高速缓存 | 2.8 |
| L3高速缓存 | 12.9 |
| 主存储器引用 | 100 |
| 使用Snzip压缩1KB | 3,000（3 微秒） |
| 从内存顺序读取1MB | 9,000（9微秒） |
| 从SSD顺序读取1MB | 200,000（200微秒） |
| 相同数据中心的往返时间 | 500,000（500微秒） |
| 使用速度约为1GB/sec的SSD从SSD顺序读取1MB | 1,000,000（1毫秒） |
| 磁盘查找 | 4,000,000（4毫秒） |
| 从磁盘顺序读取1MB | 2,000,000（2毫秒） |
| 发送数据包从旧金山到纽约 | 71,000,000（71毫秒） |

除了上述列出的延迟时间之外，还有以每秒查询(QPS)为单位衡量的吞吐量数字，典型单服务器数据存储可以处理其中的数据。
## 重要的吞吐率
| | |
| ------------------------------ | ----------- |
| MySQL处理的QPS | 1000 |
| 键值存储处理的QPS | 10,000 |
| 缓存服务器处理的QPS | 100,000-1 M |

上述数字是近似值，并且在很多方面存在巨大的差异，如查询的类型（点查询和范围查询）、机器规格、数据库设计、索引等。

## 请求评估本节讨论了一个典型服务器在一秒钟内能够处理的请求数。服务器内部存在有限的资源，并且根据客户端请求的类型不同，不同的资源可能成为瓶颈。让我们了解两种类型的请求。 

- **CPU绑定的请求：**这是一种以CPU为限制因素的请求。 
- **内存绑定的请求：**这是一种受到机器内存数量限制的请求。 

让我们近似计算每种类型请求的RPS。但在此之前，我们需要假设以下内容： 

- 我们的服务器具有上述表中定义的典型服务器的规格。 
- 操作系统和其他辅助进程已经消耗了总计16GB的RAM。 
- 每个 worker 消耗 300MB 的RAM存储来完成一个请求。 
- 为简单起见，我们假设CPU从RAM获取数据。因此，缓存系统确保所有所需的内容可用于提供服务，而无需访问存储层。 
- 每个CPU绑定的请求需要200毫秒，而每个内存绑定的请求需要50毫秒才能完成。 

让我们计算每种请求类型。 

**CPU绑定：**用于计算CPU绑定请求RPS的简单公式如下： 

![搜狗截图20230406184701](/img/05-Back-of-the-envelope Calculations/搜狗截图20230406184701.png)

上述计算的基础是我们可以将一秒钟视为一个盒子，并计算有多少个小盒子（任务）能够适合在大盒子内完成，即每个CPU在一秒钟内能够完成的任务数。因此，更多的CPU/线程将导致更高的RPS。 

**内存绑定请求：**对于内存绑定请求，我们使用以下公式： 

![搜狗截图20230406184714](/img/05-Back-of-the-envelope Calculations/搜狗截图20230406184714.png)

上述计算仅是估算RPS所涉及的基本因素。实际上，还有许多其他因素起作用。例如，在磁盘上执行搜索以查找数据或向数据库服务器发出请求需要延迟，这也将包括数据库和网络延迟。另外，查询类型也很重要。当然，故障、代码错误、节点故障、停电、网络中断等都是不可避免的因素。 

在典型情况下，各种类型的请求到达，一台只能从RAM中提供静态内容的强大服务器可能处理多达500k RPS。在另一端的极端情况下，计算密集型任务（如图像处理）可能仅允许最多50 RPS。 

> **注意:**实际上，容量估计是一个艰难的问题，组织经过多年的实践，学会了如何改进它。监控系统会关注我们基础设施的所有部分，以提前警告我们服务器超载的情况。