# 分片计数器的详细设计

了解分片计数器的详细设计。

## 详细设计

现在，我们将详细讨论分片计数器的三个主要功能--创建、写入和读取。我们将以 Twitter 为例回答许多重要的问题。这些问题包括：

- 每个新推文应创建多少个分片？
- 特定推文的分片值如何递增？
- 当终端用户发出读取请求时，系统会发生什么？

### 分片计数器的创建

正如我们之前所讨论的，当用户在 Twitter 上发布一条推文时，会调用 `\createCounter` API。系统会为每个新创建的用户帖子创建多个计数器。以下是针对每个新推文创建的主要计数器列表：

- 推文点赞计数器
- 推文回复计数器
- 推文转发计数器
- 推文查看计数器（如果推文包含视频）

现在，问题是系统如何决定每个计数器中分片的数量？分片数量对于良好的性能至关重要。如果对于特定的写入工作负载，分片数较少，我们将面临高写入争用，导致写入缓慢。另一方面，如果对于特定的写入配置文件，分片数过高，我们将在读取操作中遇到更高的开销。读取缓慢的原因是因为需要从不同分布式数据中心中可能驻留在不同节点上的不同分片中收集值。计数器值的读取成本随着分片数量的增加而线性增加，因为要添加各个计数器分片的值。随着添加新分片的请求数量的增加，写入的扩展呈线性比例增长。因此，在快速进行写入和读取性能之间存在权衡。我们将在稍后讨论如何改进读取性能。

分片数量的决定取决于许多因素，这些因素共同尝试在短期内预测特定计数器的写入负载。对于推文，这些因素包括关注者数量。 Twitter 上有数百万关注者的用户的推文将获得比关注者较少的用户更多的分片，因为有可能他们的推文会获得许多点赞，通常是数百万个。有时，名人推文包括一个或多个标签。系统还会为此标签创建分片计数器，因为它有很高的可能被标记为趋势。

许多以人为中心的活动通常具有长尾活动模式，许多人集中在相对较小的一组活动上。也许缩短的注意力可能在这里起着作用。这意味着一段时间后，点赞的热潮会逐渐消失，我们现在不需要像之前那样多的分片来处理计数器。同样，我们对未来写入的初始预测可能会出现偏差，我们可能需要更多的分片来处理写入请求。我们要求我们的系统能够根据当前需求动态扩展或缩小分片数量。

我们需要监视所有分片的写入负载，以适当地将请求路由到特定的分片，可能使用负载均衡器。这样的反馈机制也可以帮助我们决定何时关闭某些计数器的分片以及何时添加其他分片。这个过程不仅为最终用户提供了良好的性能，而且还以接近最优水平利用了我们的资源。

值得思考的一点

###### 问题

如果一个关注者很少的用户在 Twitter 上发布了一条病毒式的推文，会发生什么？

隐藏答案

系统需要检测这种情况，其中计数器开始意外地获得非常高的写入流量。我们将动态增加受影响计数器的分片数以减轻情况。

### 写入请求的突发

正如我们之前提到的，数百万用户与我们的示例名人推文互动，最终向系统发送了一系列写入请求。系统将每个写入请求分配给特定推文的指定计数器的可用分片。系统如何选择操作于不同计算单元（节点）上的这些分片以分配写入请求？我们可以使用三种方法来解决这个问题：

#### 轮询选择

解决上述问题的一种方法是使用分片的轮询选择。例如，假设分片数为100。系统从shard_1开始，然后选择shard_2，一直到选择shard_100。通常，轮询工作分配会过载或未充分利用资源，因为调度是在不考虑当前负载条件的情况下完成的。但是，如果每个请求都相似（并且大致需要相同的时间来服务），则可以使用轮询方法，并且其简洁性很有吸引力。

在下面的插图中，我们假设用户请求首先由负载均衡器分配到适当的服务器。然后，每个这样的服务器使用自己的轮询调度来使用分片：

![QQ截图20230410160647](https://chat.openai.com/img/24-Sharded Counters/QQ截图20230410160647.png)

![QQ截图20230410160703](../../../../../newContent/25-Concluding%20the%20Building%20Blocks%20Discussion/img/24-Sharded%2520Counters/QQ%25E6%25%E6%88%AA%E5%9B%BE20230410160703.png)

![QQ截图20230410160722](https://chat.openai.com/img/24-Sharded Counters/QQ截图20230410160722.png)

![QQ截图20230410160734](https://chat.openai.com/img/24-Sharded Counters/QQ截图20230410160734.png)

![QQ截图20230410160745](https://chat.openai.com/img/24-Sharded Counters/QQ截图20230410160745.png)

使用轮询技术选择分片

#### 随机选择

另一种简单的方法是随机均匀选择要写入的分片。轮询选择和随机选择的挑战在于节点（分片所在的节点）上的负载变化。适当分配可用分片上的负载很难。节点上的负载变异很常见，因为物理节点经常用于多个用途。

