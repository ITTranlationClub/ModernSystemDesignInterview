# 数据库中的权衡

学习何时使用横向分片而不是竖向分片以及反之。


## 哪种数据库分片方法最好？

无论是横向还是竖向分片都涉及向计算基础设施添加资源。我们的业务利益相关者必须决定哪种适合我们的组织。我们必须相应地扩展我们的资源，以使我们的组织和业务增长，以避免停机时间并减少延迟。我们可以通过对 CPU、物理内存需求、硬盘调整和网络带宽的调整的组合来扩展这些资源。

以下部分解释了有分片与无分片的优缺点。

### 集中式数据库的优缺点

#### 优点

- 数据维护，如对集中式数据库进行更新和备份，非常容易。
- 集中式数据库比分布式数据库提供更强的一致性和 ACID 事务。
- 相比于分布式数据库，集中式数据库为最终编程人员提供了更简单的编程模型。
- 对于企业来说，存储少量可驻留在单个节点上的数据更为高效。

#### 缺点

- 当每秒访问集中式数据库的查询数量接近单节点限制时，中央数据库可能会变慢，导致最终用户的延迟很高。
- 集中式数据库存在单点故障。因此，其无法访问的可能性更高。

### 分布式数据库的优缺点

#### 优点

- 访问分布式数据库中的数据非常快捷和简单，因为数据是从最近的数据库分片或最常用的数据库分片中检索出来的。
- 不同等级的分布透明度的数据可以存储在不同的位置。
- 由查询组成的密集事务可以被分成多个优化的子查询，可以并行地进行处理。

#### 缺点

- 有时需要从多个站点获取数据，这需要比预期的更长的时间。
- 关系被垂直或水平地分区在不同的节点之间。因此，这些操作需要仔细地获取数据来重新构造完整的关系。这些操作可能变得更加昂贵和复杂。
- 在分布式数据库中维护一致的数据比较困难，并且需要额外的措施。
- 分布式数据库中的更新和备份需要时间来同步数据。

### 分布式数据库中的查询优化和处理速度

分布式数据库中的事务取决于查询类型、涉及的站点（分片）数量、通信速度以及其他因素，例如底层硬件和使用的数据库类型。不过，作为示例，假设查询需要访问存储在不同站点上的三个表`Store`、`Product`和`Sales`。

每个表中的属性数如下图所示：

![QQ 截图 20230407115228](/img/09-Databases/QQ截图20230407115228.png)

由三个表组成的数据库模式：Store、Product 和 Sales

假设这两个表的分布在不同站点上如下：

- `Store`表在站点 A 上存储 10,000 个元组。
- `Product`表在站点 B 上存储 100,000 个元组。
- `Sales`表在站点 A 上存储 1,000,000 个元组。

现在，假设我们需要处理以下查询：

```sql
Select Store_key from (Store JOIN Sales JOIN Product)
where Region= 'East' AND Brand='Wolf';
```

以上查询在 `Store`、`Sales` 和 `Product` 表上执行联接操作，并从联接操作结果生成的表中检索 `Store_key` 值。

接下来，假设每个存储的元组长达 200 位。这相当于 25 字节。此外，某些中间结果的估计基数如下：

- `Wolf` 品牌的数量为 10。
- `East` 地区的商店数量为 100,000。

通信假设如下：
- 数据速率 == 50M比特每秒
- 访问延迟 == 0.1秒

#### 参数假设
在使用不同方法处理查询之前，让我们定义一些参数：
- 总访问延迟
- 数据速率
- 总数据量

现在，根据以下公式计算总通信时间：

```
总通信时间 = total access delay + (total data volume / data rate)
```

接下来，我们尝试执行以下可能的查询方法。

![QQ截图20230407115248](/img/09-Databases/QQ截图20230407115248.png)

#### 可能的查询方法
1. 将Product表移动到A站点并在A站点处理查询。这里，0.1是A站点上表的访问延迟，100,000是Product表中元组的数量。每个元组的位数为200，50,000,000是数据速率。200和50,000,000这两个数字对于以下所有计算都是相同的。
2. 将Store和Sales移动到B站点并在B站点处理查询。这里，0.2是Store和Product表的访问延迟。10,000和1,000,000是Store和Product表中元组的数量。
3. 在B站点将Brand限制为Wolf（称为选择）并将结果移动到A站点。这里，0.1是Product表的访问延迟。Wolf品牌的数量是10，因此元组数量为10。

![QQ截图20230407115258](/img/09-Databases/QQ截图20230407115258.png)

当我们比较这三种方法时，第三种方法提供了最小的延迟（0.1秒）。该示例显示，在分布式数据库中，精心优化的查询也是至关重要的。

### 结论
数据在多个节点之间的分布（垂直和水平分片）旨在通过优化查询来改进以下特性：
- 可靠性（容错）
- 性能
- 平衡的存储能力和成本

集中式数据库和分布式数据库都有它们的利弊。我们应该根据应用程序的需求选择它们。