# 数据库类型

了解各种数据库类型及其在系统设计中的用例。正如我们之前讨论的那样，数据库被分为两种类型：关系型和非关系型。让我们深入讨论这些类型。

## 关系型数据库

**关系型数据库**在存储数据之前遵循特定的架构。存储在关系型数据库中的数据具有先前的结构。通常，此模型将数据组织到一个或多个关系（也称为表）中，每个元组（实例）都有一个唯一的键。数据的每个实体都由实例和属性组成，其中实例存储在行中，每个实例的属性存储在列中。由于每个元组都有一个唯一的键，因此可以通过在其他表中存储主键来将一个表中的元组链接到其他表中的元组，通常称为外键。

使用结构化查询语言（SQL）来操作数据库，包括插入、删除和检索数据。

关系型数据库之所以如此流行和占主导地位，有各种原因，包括简单性、健壮性、灵活性、性能、可扩展性和用于管理通用数据的兼容性。

关系型数据库提供原子性、一致性、隔离性和持久性（ACID）属性，以维护数据库的完整性。ACID是一个强大的抽象，简化了与数据的复杂交互并隐藏许多异常（如脏读、脏写、读取偏差、丢失更新、写入偏差和幻读）在简单事务终止后面。

但是，从设计上来看，ACID就像一个大锤子，因此它足够通用以解决所有问题。如果某个特定的应用程序只需要处理几个异常，那么有机会使用自定义解决方案以获得更高的性能，尽管这会增加复杂性。

让我们详细讨论ACID：

- **原子性**：事务被认为是一个原子单元。因此，要么事务中的所有语句都将成功执行，要么它们都不会执行。如果事务中的某个语句失败，它应该被中止并回滚。
- **一致性**：在任何时候，数据库都应该处于一致的状态，并且每个事务完成后都应该保持一致的状态。例如，如果多个用户想要从数据库中查看记录，则每次都应该返回类似的结果。
- **隔离性**：在多个事务并发运行的情况下，它们不应相互影响。数据库的最终状态应与按顺序执行的事务的状态相同。
- **持久性**：系统应保证已完成的事务将永久地保存在数据库中，即使在系统故障事件中也是如此。

使用各种数据库管理系统（DBMS）定义关系型数据库模式以及其他操作，例如存储、检索和运行数据上的SQL查询。一些流行的DBMS如下：

- MySQL
- Oracle Database
- Microsoft SQL Server
- IBM DB2
- Postgres
- SQLite

### 为什么选择关系型数据库？

结构化数据存储的软件专业人员默认选择关系型数据库。这些数据库有许多优点。关系数据库最大的优势之一是其对ACID事务及相关编程语义的抽象。这使得最终编程人员使用关系型数据库非常方便。让我们回顾一些关系型数据库的重要特征：

#### 灵活性

在SQL上下文中，**数据定义语言（DDL）**为我们提供灵活性，使我们能够修改数据库，包括表、列、重命名表和其他更改。即使发生其他查询并且数据库服务器正在运行，DDL也允许我们修改模式。

#### 减少冗余

…## 关系型数据库的优势

关系型数据库最大的优势之一是消除数据冗余。与特定实体相关的信息出现在一个表中，而与该实体相关的其他数据则出现在通过外键链接的其他表中。这个过程称为标准化，还有一个额外的好处是消除了不一致的依赖关系。 

## 并发性

并发性是设计企业数据库时要考虑的重要因素。在这种情况下，数据由许多用户同时读写。我们需要协调这些交互以避免数据不一致，例如酒店房间的同时预订。关系型数据库中的并发性是通过对数据进行事务性访问来处理的。如前所述，事务被认为是一个原子操作，因此它也在错误处理中起作用，以便在成功执行时回滚或提交事务。

## 集成

从多个来源聚合数据的过程在企业应用程序中很常见。执行此聚合的一种常见方式是集成共享数据库，多个应用程序将其数据存储在其中。这样，所有应用程序都可以轻松访问彼此的数据，而并发控制措施则处理多个应用程序的访问。

## 备份和灾难恢复

关系型数据库保证数据在任何时间都处于一致状态。导出和导入操作使备份和恢复更加容易。大多数基于云的关系型数据库执行持续镜像以避免数据丢失，并使恢复过程更加容易和快速。

## 缺点

**妨碍匹配**是关系模型和内存数据结构之间的差异。关系模型将数据组织成关系和元组的表格结构。对此结构化数据的SQL操作产生与关系代数对齐的关系。但是，它也有一些局限性。特别是，表中的值采用简单值，不能是结构或列表。对于内存来说情况则不同，可以存储复杂的数据结构。为了使复杂的结构与关系兼容，我们需要根据关系代数对数据进行翻译。因此，阻抗不匹配需要在两个表示之间进行翻译，如下图所示：

![QQ截图20230406213538](/img/09-Databases/QQ截图20230406213538.png)

视图中的一个单一的聚合值由多个行和表组成的关系数据库。

## 为什么需要非关系型（NoSQL）数据库？

NoSQL数据库是为管理和访问多种数据模型而设计的。有各种类型的NoSQL数据库，下一节将介绍它们。这些数据库用于需要大量半结构化和非结构化数据、低延迟和灵活数据模型的应用程序。这可以通过放宽其他数据库的数据一致性限制来实现。以下是NoSQL数据库的一些特点：

- **简单设计：** 与关系型数据库不同，NoSQL不需要处理阻抗不匹配，例如将所有员工的数据存储在一个文档中，而不是多个需要联接操作的表格。这种策略使编写少量代码、调试和维护变得简单和容易。
- **水平扩展：** 主要是由于NoSQL能够在大型集群上运行数据库，因此NoSQL备受青睐。当并发用户数量增加时，这解决了问题。由于与特定员工相关的数据存储在一个文档中，而不是多个节点上的多个表格，因此NoSQL使缩放更容易。NoSQL数据库通常在多个节点上分散数据，自动平衡数据和查询。在节点故障的情况下，可以在不影响应用程序的情况下透明替换节点。## NoSQL数据库的类型及用例
- **可用性：** 为了增强数据的可用性，可以在不影响应用的情况下进行节点替换。许多非关系型数据库的变体支持数据复制以确保高可用性和容灾恢复。
- **支持非结构化和半结构化数据：** 许多NoSQL数据库处理在数据库配置或数据写入时没有模式的数据。例如，文档数据库是无结构的，它们允许具有不同字段的文档（JSON、XML、BSON等）。例如，一个JSON文档可以比另一个文档少一些字段。
- **成本：** 许多关系型数据库的许可证相当昂贵，而许多NoSQL数据库是开源且免费提供的。同样，一些关系型数据库依赖于昂贵的专有硬件和存储系统，而NoSQL数据库通常使用廉价的商品服务器集群。NoSQL数据库根据操作和特性的性质被分为各种类别，包括文档存储、列数据库、键值存储和图数据库。我们将在以下部分从系统设计的角度讨论它们及其用例。

### NoSQL数据库的类型
以下是各种类型的NoSQL数据库：

![QQ截图20230406213555](/img/09-Databases/QQ截图20230406213555.png)

#### 键值数据库
**键值数据库** 使用类似哈希表的键值方法来存储键值对数据。可以在下面的段落中看到这个示例。其中，键用作唯一或主键，值可以是任何范围从简单标量值到复杂对象。这些数据库允许数据的易于分区和横向扩展。一些流行的键值数据库包括Amazon DynamoDB、Redis和Memcached DB。

**用例：** 键值数据库对于面向会话的应用程序非常有效。面向会话的应用程序，如Web应用程序，在会话期间将用户数据存储在主内存或数据库中。此数据可能包括用户档案信息、推荐、定向促销、折扣等。为了便于访问和存储，每个用户会话分配一个唯一的ID（键）。因此，存储此类数据的更好选择是键值数据库。

以下图示例展示了键值数据库的一个示例。该产品的`Product ID`和`Type`被共同视为主键。这被认为是该键值数据库的键。此外，基于项目的性质和属性数，定义了存储项目属性的架构。

![QQ截图20230406213609](/img/09-Databases/QQ截图20230406213609.png)

在DynamoDB中以键值对的形式存储的数据，其中键是两个属性（产品ID和类型）的组合。

#### 文档数据库
**文档数据库** 旨在以XML、JSON、BSON等格式存储和检索文档。这些文档由可以包括映射、集合和标量值的层次树数据结构组成。这种类型的数据库中的文档可以具有不同的结构和数据。MongoDB和Google Cloud Firestore是文档数据库的例子。

**用例：** 文档数据库适合非结构化目录数据，如JSON文件或其他复杂的结构化分层数据。例如，在电子商务应用程序中，产品有数千个属性，由于对读取性能的影响，将其存储在关系型数据库中是不可行的。这里文档数据库发挥了作用，可以有效地将每个属性存储在单个文件中，以便管理和更快的读取速度。此外，对于内容管理应用程序，如博客和视频平台，它也是一个不错的选择。在这些应用程序中，需要存储的实体以单个文档的形式存储。# 选择正确的数据库

许多因素影响在应用中选择何种数据库。以下表格比较了关系数据库和非关系数据库，以帮助我们选择合适的一种：

| Factors | Relational Databases | NoSQL Databases |
| ---| --- | --- |
| **Data Structure** | Table-based | Document-based, Key-value, Graph, Column |
| **Schema** | Pre-defined | Flexible |
| **Query Language** | SQL | Various proprietary languages |
| **Data Access** | Static Schema, ACID Transaction, Ad-hoc queries | Dynamic Schema, Eventual Consistency, Unsupported ad-hoc queries |
| **Scalability** | Vertical Scaling | Horizontal Scaling |
| **Flexibility** | Limited | High |

## Drawbacks of NoSQL Databases

### Lack of Standardization

NoSQL并不遵循特定标准，如关系数据库遵循关系代数。从一种NoSQL数据库移植应用到另一种可能会是一项挑战。

### Consistency

在发生故障时，NoSQL数据库基于一些特定的一致性和可用性权衡提供不同的产品。我们不会有强数据完整性，如关系数据库中的主键和引用完整性。数据可能不是强一致但慢慢趋于收敛，采用像最终一致性这样的弱模型。

## 图形数据库

**图形数据库**使用图数据结构存储数据，其中节点表示实体，边表示实体之间的关系。基于关系的节点组织导致节点之间出现有趣的模式。此数据库允许我们只需存储数据一次就可以根据关系不同地解释它。流行的图形数据库包括Neo4J、OrientDB和InfiniteGraph。图形数据保存在存储文件中以进行持久化存储。每个文件包含图的特定部分中的数据，例如节点、链接、属性等。

下面的图展示了使用图形数据结构存储了一些数据，节点通过表示节点之间关系的边连接在一起。每个节点都有一些属性，如“名称”、“ID”和“年龄”。具有“ID: 2”的节点具有名称为“James”和年龄为“29”的属性。

![QQ截图20230406213621](/img/09-Databases/QQ截图20230406213621.png)

## 列数据库

**列数据库**将数据存储在列中而不是行中。它们使得快速高效地访问数据库列中的所有条目成为可能。流行的列数据库包括Cassandra、HBase、Hypertable和Amazon SimpleDB。

### 用例

列数据库对于大量聚合和数据分析查询非常有效。它们可以极大地减少磁盘I/O要求和从磁盘加载的数据量。例如，在与金融机构相关的应用程序中，需要对一段时间内的金融交易求和。列数据库通过仅读取金额列来使此操作更快速，而忽略客户的其他属性。

下面的图展示了列数据库的示例，其中数据以列向格式存储。这与关系数据库不同，后者以需要在行上。

![QQ截图20230406213645](/img/09-Databases/QQ截图20230406213645.png)

## 用例

图形数据库可以在社交应用程序中使用，提供不同类型的用户和他们的活动之间的有趣事实和数字。图形数据库的重点是存储数据，并为实体之间的关系驱动分析和决策铺平道路。图形数据库的性质使其适用于各种应用，例如数据规范与隐私、机器学习研究、基于金融服务的应用程序等。

列数据库适用于需要大量聚合和数据分析查询的应用程序。它们可极大地减少磁盘I/O需求和需要从磁盘加载的数据量。例如，在与金融机构相关的应用程序中，有必要对一段时间内的金融交易求和。列数据库通过仅仅读取金额列来使得此过程更快速，而不用管客户的其他属性。

综上所述，当我们选择数据库时，要考虑许多因素，例如数据结构、模式、查询语言、可访问性，扩展性和灵活性。根据应用程序的需要确定最佳方案。## 关系型和非关系型数据库

| **关系型数据库**                                       | **非关系型数据库**                             |
| ------------------------------------------------------- | ---------------------------------------------- |
| 如果需要存储的数据是结构化的                         | 如果需要存储的数据是非结构化的               |
| 如果需要 ACID 属性                                    | 如果需要序列化和反序列化数据                 |
| 如果数据大小相对较小且可以适应单个节点                | 如果需要存储的数据大小较大                   |

> **注**：当 NoSQL 数据库首次出现时，与传统数据库相比，它们在程序和使用方面有很大的差异。然而，在过去的许多年中，学术界和工业界进行了广泛的研究，使得 NoSQL 和传统存储之间面向程序员的差异正在变得模糊。我们可以使用相同的 SQL 构造来访问 NoSQL 存储，获得与传统存储相似的性能和一致性。Google 的 Cloud Spanner 就是这样一种数据库，它具有地理复制、自动水平分片和高速全局数据快照功能。

## 测验

通过测验来测试您关于不同类型数据库的知识。

1. 当我们有非结构化数据并且需要高性能时，应该使用哪种数据库？

2. 我们在什么情况下应该避免选择关系型数据库？

3. 如果我们制作了一个需要将数据以表格格式存储的零售店应用，应该使用哪种数据库？

4. 如果要制作像 Facebook 这样的应用程序，应该使用哪种数据库？

5. 我们应该将文档导向型数据库用于哪些应用程序？

6. 我们应该将键值数据库用于哪些情况？