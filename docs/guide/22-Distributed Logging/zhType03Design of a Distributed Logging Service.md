# 分布式日志服务的设计

学习如何设计一个分布式日志服务。

现在我们将设计分布式日志系统。我们的日志系统应该能够记录所有活动或消息（我们将不会在设计中包含抽样功能）。

## 需求

让我们列出设计分布式日志系统的要求：

### 功能需求

我们系统的功能需求如下：

- **写入日志**：分布式系统的服务必须能够写入日志系统。
- **可搜索的日志**：系统应该轻松查找日志。同样，在端到端的应用程序流中也应轻松实现。
- **存储日志**：日志应该存储在分布式存储中以便轻松访问。
- **集中化日志可视化程序**：系统应该提供全球分离服务的统一视图。

### 非功能需求

我们系统的非功能需求如下：

- **低延迟**：记录日志是一个 I/O 密集型操作，通常比 CPU 操作慢得多。我们需要设计系统，使记录日志不在应用程序的关键路径上。
- **可扩展性**：我们希望我们的日志系统具有可扩展性。它应该能够处理随着时间的推移和并发用户数量的增加而增加的日志量。
- **可用性**：日志系统应该具有高度可用性以记录数据。

## 我们将使用的构建模块

设计分布式日志系统将利用以下构建模块：

- **Pub-sub 系统**：我们将使用 pub-sub 系统处理大量日志。

- **分布式搜索**：我们将使用分布式搜索来高效地查询日志。

![](../img/22-Distributed%20Logging/QQ%E6%88%AA%E5%9B%BE20230410140051.png)

## API 设计

本问题的 API 设计如下：

**写入消息**

执行写入操作的 API 调用应该像这样：

```txt
write(unique_ID, message_to_be_logged)
```

| 参数 | 描述                                                         |
| :--- | :----------------------------------------------------------- |
| `unique_ID` | 它是包含 `application-id`、`service-id` 和时间戳的数字 ID。 |
| `message_to_be_logged` | 它是存储在唯一键下的日志消息。 |

**搜索日志**

搜索数据的 API 调用应该像这样：

```txt
searching(keyword)
```

这个调用返回包含关键字的日志列表。

| 参数 | 描述                                               |
| :--- | :------------------------------------------------- |
| `keyword` | 它用于查找包含 `keyword` 的日志。 |

## 初始设计

在分布式系统中，全球范围内的客户端通过请求不同的服务节点生成事件。节点在处理每个请求时生成日志。这些日志在各自的节点上积累。

除了构建模块之外，让我们列出我们系统的主要组件：

- **日志累加器**：收集每个节点的日志并将其转储到存储中的代理。因此，如果我们想了解特定事件，我们不需要访问每个节点，而是可以从存储中获取它们。

- **存储**：日志在积累之后需要存储在某个地方。我们将选择 Blob 存储来保存我们的日志。

- **日志索引器**：不断增长的日志文件影响搜索能力。日志索引器将使用分布式搜索来高效地搜索。

- **可视化程序**：可视化程序用于提供所有日志的统一视图。

该方法的设计如下：

![](../img/22-Distributed%20Logging/QQ%E6%88%AA%E5%9B%BE20230410140131.png)

在分布式系统中有数以百万计的服务器，使用单个日志累加器严重影响可扩展性。让我们了解如何扩展我们的系统。