# 分布式任务调度器的设计考虑事项

了解分布式任务调度器的设计考虑事项。

## 排队

分布式队列是调度器使用的一个主要构件。最简单的调度方法是将任务按照“先到先服务”的方式推入队列中。如果集群（云）中有10000个节点（资源），任务调度器会快速地从队列中提取任务并在节点上进行调度。但是，如果所有资源当前都在忙碌状态，那么任务将需要在队列中等待，小型任务可能需要等待更长时间。

这种调度机制会影响系统的可靠性、系统的可用性和任务的优先级。有时候，我们希望任务能够紧急执行，例如通知用户他们的账户从未识别的设备上进行了访问。因此，我们不能仅仅依赖先到先服务来调度任务。相反，我们将任务分类并设置适当的优先级。我们为任务设置了以下三个类别：

- 不能延迟的任务。
- 可以延迟的任务。
- 需要定期执行的任务（例如，每5分钟、每小时或每天执行一次）。

![QQ截图20230410142713](/img/23-Distributed%20Task%20Scheduler/QQ%E6%88%AA%E5%9B%BE20230410142713.png)

基于任务类别的多个队列

我们的系统确保非紧急队列中的任务不会饥饿。一旦某个任务的延迟限制即将到达，它就会被移动到紧急任务队列中，以便获得服务。接下来我们将在本课程的后面看到任务调度器如何实现优先级。

让我们探讨一些有助于调度器有效利用资源并向用户提供可靠服务的参数。

## 执行时间限制

一些任务执行的时间非常长并占用资源，会阻塞其他任务。在调度任务时，**执行时间限制**是一个重要的参数。如果我们将一个资源完全分配给一个任务并等待该任务完成，某些任务可能无法停止，因为任务脚本中存在无法让其完成执行的错误。我们让客户端为其任务设置执行时间限制。在指定的时间后，我们应该停止任务执行、释放资源并将其分配给队列中的下一个任务。如果任务执行因执行时间限制而停止，我们的系统会通知相应的客户端。对于这些情况，客户端需要采取适当的纠正措施。

如果客户端没有设置执行时间限制，调度器将使用其默认的允许最长时间的上限来终止任务。假设一个任务实际上需要更长时间，例如我们正在训练一个机器学习模型。在这种情况下，调度器可能需要暂停和恢复多次来容纳其他任务。对于只使用基本（免费）账户的用户，云服务商不能让任务无限制地执行，因为使用他们的资源需要付费。为了处理这种情况，客户端会收到有关最大使用限制的信息，以便他们可以处理长时间执行的任务。例如，客户端可以设计其任务以在一定时间后进行检查点，如果由于使用限制导致资源被客户端占用，则可以从该状态加载以恢复进度。

思考一下

###### 问题

如果一个长时间的任务已经执行了90%，但在完成之前执行此任务的机器失败了，该怎么办？

隐藏答案

任务调度器将在其他机器上重新执行该任务。任务需要是幂等的，这将在课程的后面进行讨论，或者它们应该能够从之前的检查点恢复其状态。一旦状态被保存，我们就可以在任何其他机器上继续执行该任务。这使我们的系统具有容错性并节省了我们的资源。

## 优先级

（待续）有一些任务需要紧急执行。例如，在社交应用程序例如Facebook中，用户可以在紧急情况下（例如地震）将自己标记为“安全”。 执行此操作的任务应及时执行，否则此功能对Facebook用户将是无用的。 将电子邮件通知发送给客户，告知他们的帐户已被借记一定金额也是需要紧急执行的任务的另一个例子。为了将任务进行优先排序，任务调度程序为每个任务维护一个**延迟容忍度**参数，并在其延迟容忍度附近执行该任务。**延迟容忍度**是任务执行可能被延迟的最长时间。最短延迟容忍度时间的任务首先执行。通过使用延迟容忍度参数，我们可以推迟具有较长延迟容忍度值的任务，以便在高峰期间为紧急任务留出空间。深思熟虑###### 问题我们如何确定延迟容忍度的价值？隐藏答案由于各种应用程序中存在不同类别的任务，应用程序所有者或客户可以自己设置或自动化价值，具体取决于任务类别。例如，在社交媒体应用程序例如Facebook中，我们可以生成新闻提要，建议朋友，允许用户在灾难之后标记自己为安全，向用户发送有关现场直播活动的通知等。列出的任务中，标记地震期间的人员安全和发送有关直播活动的通知应该是优先任务。客户可以将这些任务的延迟容忍度值缩小到毫秒或几秒钟，而像建议朋友这样的任务可以被延迟数天。任务调度系统本身可以根据任务类别及其严重程度设置延迟容忍值。不同的优先级有不同的成本（例如高优先级任务通常有更高的成本），以便客户可以仔细分类其任务。## 资源容量优化在资源接近过载阈值（例如，使用率超过80％）的时间，可能会产生**高峰时间**。同一资源在非高峰时间可能处于空闲状态。因此，我们必须思考如何在非高峰时间更好地利用资源以及如何在高峰期间保持资源可用。有些任务不需要紧急执行。例如，在社交应用程序例如Facebook中，建议朋友不是紧急任务。我们可以为此类任务创建单独的队列，并在非高峰时间执行它们。如果我们的工作量始终比可用资源多，则可能存在容量问题，为了解决这个问题，我们应该投入更多资源。云提供商需要拥有目标**资源对需求**比率。当需求开始增加时，比率将朝0移动。如果比率随时间变化，提供商可能决定投入更多或更少的资源。## 任务幂等性如果任务成功执行，但由于某种原因机器未能发送确认，调度程序将再次安排任务。任务将再次执行，我们最终会得到错误的结果，这意味着该任务是非幂等的。下面的图示例是非幂等性的示例：![QQ截图20230410143358](/img/23-Distributed%20Task%20Scheduler/QQ%E6%88%AA%E5%9B%BE20230410143358.png)![QQ截图20230410143614](/img/23-Distributed%20Task%20Scheduler/QQ%E6%88%AA%E5%9B%BE20230410143614.png)```A有20美元。它提交请求将10美元发送到B帐户中，B帐户中的金额为0美元。A是发件人，B是收件人服务器开始将10美元添加到B的帐户中，但未成功执行此操作服务器向A发送错误消息 A重试事务服务器开始将10美元添加到B的帐户中。这个时间服务器成功地执行了将10美元添加到B的账户的操作，B的余额得到更新。服务器向A发送了确认，但由于某些错误而未能成功。A重新尝试交易，服务器重新开始将10美元添加到B的账户的操作。将10美元添加到B的账户的操作成功执行，B的账户再次添加了10美元。B的余额已变为20。客户端已收到确认，但最终输出有误。B的账户里添加了20美元，而不是10美元，并且A的账户还额外扣除了10美元。我们不希望在再次执行任务时最终结果发生变化。在金融应用程序中转移资金是至关重要的，因此我们要求任务具有幂等性。幂等性任务产生相同的结果，无论我们执行多少次。下面是幂等性任务的执行示例：（幂等性：幂等性是数学和计算机科学中某些操作的一个特征，使它们能够多次应用而不影响结果。）![QQ截图20230410143840](/img/23-Distributed%20Task%20Scheduler/QQ%E6%88%AA%E5%9B%BE20230410143840.png)

A发出请求，用应用添加的幂等键将10美元发送给B。服务器开始将10美元添加到B的账户的操作，但没有成功。服务器向A发送错误消息。A重试交易，并将相同的幂等键附加到重试请求中。服务器开始将10美元添加到B的账户的操作。这次服务器成功地执行了将10美元添加到B的账户的操作。服务器向A发送确认，但由于某些错误而丢失。A重新尝试交易，并在重试请求中附加了幂等键。服务器发现了幂等性键，因此不会再将10美元添加到B的账户中。客户端接收到确认，我们得到了正确的输出。A有10美元，B有10美元。![QQ截图20230410144837](/img/23-Distributed%20Task%20Scheduler/QQ%E6%88%AA%E5%9B%BE20230410144837.png)让我们将上传视频到数据库的任务变成幂等性操作。如果上传者没有收到确认，我们不希望视频在数据库中重复。幂等性确保视频不会重复。开发人员在实现中通过识别视频的某些内容（例如名称）并覆盖旧内容来添加此属性。这样，无论有多少人上传它，最终结果都是相同的。幂等性使我们能够简单地重新执行失败的任务。

思考问题###### 问题我们应该如何处理由于任务负载中的无限循环而永远无法完成的任务执行？隐藏答案我们需要标记和终止此类任务。因此，为此目的，我们可以设置时间限制。如果它花费的时间超过指定的执行上限值，我们可以杀死该任务。但是区分错误的任务和长时间的任务是具有挑战性的。我们可以在应用程序级别处理它，在这里客户端通过在不同时间保存状态来处理长时间任务。如果任务计划程序杀死该任务，客户端也可以从该状态中恢复，假设该任务包含无限循环。

## 安排和执行不可信任务

在继续之前，让我们问自己一个问题：什么是不可信任务，我们该如何管理它们？

如果您不确定答案，请单击下面的“显示提示”按钮：

```不可信任务是其中存在任务脚本中的恶意指令可能会影响其他租户的任务执行的任务。受影响的任务可能是其他租户的任务。不受信任的任务还可能损害操作系统或执行它们的资源。```程序存在潜在的bug，也可能具有恶意意图。当使用任务调度器时，我们应该小心，确保一个任务不会对其他任务产生负面影响。如果我们提供基础架构作为服务，安全性是必不可少的组成部分。这是因为租户可以通过在共享环境中执行恶意代码来更轻松地损害彼此的任务。执行恶意代码也可能会损坏我们的基础架构。因此，我们需要考虑以下几点：- 使用适当的身份验证和资源授权。- 考虑使用dockers或虚拟机的代码沙箱。- 通过监视任务的资源利用率并限制（或终止）行为不良的任务来使用任务之间的性能隔离。思考问题###### 问题当同一个任务多次失败时会发生什么？隐藏答案我们可以使用死信队列功能来隔离重复失败的任务。现在，让我们在下一课中评估我们的分布式任务调度程序的设计。