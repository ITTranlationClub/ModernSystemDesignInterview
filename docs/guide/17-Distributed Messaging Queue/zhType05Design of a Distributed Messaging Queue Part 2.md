# 分布式消息队列的设计: 第二部分

学习消息队列的详细设计和其在后端服务器上的管理。

在上一节中，我们讨论了前端服务器和元数据服务的责任。在本节中，我们将重点关注设计的主要部分——队列和消息的存储：后端服务。

## 后端服务

这是架构的核心部分，其中主要活动发生。当前端收到一个消息时，它会参考元数据服务来确定消息需要发送的主机。然后，消息被转发到主机并在相关主机上进行复制，以克服可能的可用性问题。在不同主机上的集群中进行消息复制可以使用以下两种模型之一:

1. *主次模型*
2. *独立主机集群*

在深入研究这些模型的细节之前，让我们讨论负责队列管理的两种集群管理器：*内部*和*外部*集群管理器。这两种集群管理器之间的区别如下表所示。

## 内部与外部集群管理器

 | **内部集群管理器** | **外部集群管理器** |
| -------------------- | -------------------- |
| 它管理集群中队列的分配。 | 它管理跨多个集群的队列分配。 |
| 它知道集群中每个节点的情况。 | 它知道每个集群的情况。但是，它没有关于每个集群内部存在的所有主机的信息。 |
| 它从每个节点接收心跳。  | 它监视每个独立集群的健康状况。 |
| 它负责处理主机故障、实例添加和从集群中移除等事宜。 | 它管理和利用集群。 |
| 它将队列划分为几个部分，每个部分有一个主服务器。 | 它可能将一个队列分隔成几个集群，以便将同一队列的消息平均分布在几个集群之间。 |

### 主次模型

在**主次模型**中，每个节点被视为一组队列的**主机**。主机的职责是接收特定队列的请求并完全负责数据复制。前端接收到请求后，与元数据服务通信以确定请求的主机。

例如，假设我们有两个队列，其标识为101和102，分别位于四个不同的主机A、B、C和D上。在此示例中，实例B是队列101的主机，队列101的副本被复制到A和C的辅助主机上。随着前端接收到消息请求，它通过内部集群管理器从元数据服务中确定主服务器。消息从主实例中检索，该实例也负责在使用后删除原始消息及其所有副本。

如下图所示，内部集群管理器是负责主机、辅助主机和队列之间映射的组件。此外，它还帮助进行主机选择。因此，它需要可靠、可扩展和高性能。

![](/img/17-Distributed%20Messaging%20Queue/PrimarySecondaryModelOfDistributedQueue.png)

分布式队列的主次模型:收到队列ID为101的请求，按照请求进行处理

### 独立主机集群

在**独立主机集群**中，每个节点都是独立的。消息可以在不同节点之间进行复制，而无需主副本之间的复制。这种模型比主次模型更容易扩展，但需要考虑数据一致性和重复传递的问题。集群管理器可以使用基于版本的控制来解决此类问题。

## 结论

在本节中，我们了解了一些常用的分布式队列设计模型。为了实现高性能、高可靠性和高扩展性，需要认真考虑集群管理器的选择和实现。在下一节中，我们将讨论如何在分布式消息队列中实现事务。在涉及到**独立主机群集**的方法中，我们有多个分布在数据中心的多个独立主机群集。当前端接收到消息时，它通过外部群集管理器的元数据服务确定相应的群集。然后，消息被转发到群集中的随机主机，该主机在存储队列的其他主机中复制消息。反思点###### 问题一个群集内的随机主机如何复制数据-即同一群集内其他主机中的队列中的消息？隐藏答案每个主机都由在群集中的队列和主机之间的映射组成，使复制更加容易。假设我们有一个群集，Y，其中包括主机A、B和C。该群集有两个ID为101和103的队列分别存储在不同的主机上，如下表所示。该表在群集Y中的每个主机上都存储。当一个随机主机收到一个消息，比如主机C，对于一个具有ID为103的队列，主机C在存储队列103的其他主机，即节点A和节点B上复制这个消息。![img](/img/17-Distributed%20Messaging%20Queue/nodeTable.png)相同的过程适用于从消费者接收消息请求。与第一种方法类似，随机选择的主机负责在成功处理消息后进行消息传递和清理。此外，还引入了另一个称为外部群集管理器的组件，该组件负责维护队列和群集之间的映射，如下图所示。外部群集管理器还负责队列管理和群集分配到特定队列。下图说明了独立主机群集。有两个群集A和B，它们由多个节点组成。外部群集管理器具有队列及其对应群集的映射表。每当前端接收到队列请求时，它确定队列对应的群集，并将请求转发到队列所在的群集中。该群集中的节点负责相应地存储和发送消息。![](/img/17-Distributed%20Messaging%20Queue/AClusterOfIndependentHosts.png)由分布式队列组成的独立主机群集反思点###### 问题在将消息复制到其他主机时可能出现哪些异常情况？隐藏答案有两种在多个主机上存储队列中复制消息的方式。同步复制和异步复制。在同步复制中，主机负责在其他主机的所有相关队列中复制消息。在从辅助主机接收确认后，主机向客户端通知接收到消息。采用此方法，消息在所有队列副本中保持一致，但通信延迟成本较高，在晋升辅助主机为主机的选举进行时可能导致部分或没有可用性。在异步复制中，一旦主机收到消息，它就会向客户端确认，并在下一步中开始在其他主机中复制消息。该方法也带来其他问题，如复制滞后和一致性问题。根据应用程序的需求，我们可以选择其中一种。我们已完成了分布式消息队列的设计，并讨论了组织后端服务器的两个模型。我们还描述了队列管理的过程以及如何在后端处理消息。此外，我们还讨论了如何通过不同的群集管理器管理后端服务器。在下一课中，我们将讨论我们的系统如何满足本章先前描述的功能和非功能要求。