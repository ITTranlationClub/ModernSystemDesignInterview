---
typora-root-url: ..
---

# 设计一个分布式消息队列：第一部分

了解一个消息队列的高级设计和如何扩展队列的元数据。

到目前为止，我们已经讨论了一个分布式消息队列的要求和设计考虑因素。现在，让我们开始学习一个分布式消息队列的高级设计。

## 分布式消息队列

与单服务器消息队列不同，分布式消息队列存在于多个服务器上。分布式消息队列具有自己的挑战，但是如果设计得当，它可以解决单服务器消息队列的缺点。

以下几节将重点介绍分布式消息队列的可扩展性、可用性和耐久性问题，并向我们介绍消息队列的更具容错性的架构。

### 高级设计

在深入设计之前，让我们假设以下几点，使讨论更加简单易懂。在接下来的材料中，我们将讨论以下假设如何使我们能够消除单服务器解决消息队列的问题。

1. 队列数据使用群集内的主从或类似仲裁的机制进行复制（请阅读[数据复制](https://www.educative.io/collection/page/10370001/4941429335392256/5241733675220992)课程了解更多细节）。如果队列过长无法放在一个服务器上，我们的服务可以使用数据分区。我们可以使用类似一致性哈希的方案，或者我们可以使用键值存储，其中键可能是消息的序列号。在这种情况下，每个碎片都被适当地复制（请参阅[分区](https://www.educative.io/collection/page/10370001/4941429335392256/6254160546103296)课程以获取更多详细信息）。

2. 我们还假设我们的系统可以根据需要自动扩展和自动收缩资源，以充分利用资源。

以下图表演示了由几个组件组成的分布式消息队列的高级设计。

![HighLevelArchitecture](/img/17-Distributed%20Messaging%20Queue/HighLevelArchitecture.png)

分布式消息队列的高级体系结构

我们设计的基本组件将在下面详细介绍。

#### 负载均衡器

负载均衡层接收来自生产者和消费者的请求，并将其转发到前端服务器之一。这个层由多个负载均衡器组成。因此，请求以最小的延迟被接受，并提供高可用性。

#### 前端服务

前端服务由分布在数据中心的无状态机器组成。 前端提供以下服务：

- **请求验证：** 这确保请求的有效性并检查其是否包含所有必要的信息。
- **身份验证和授权：** 这项服务检查请求者是否是有效的用户，以及这些服务是否经过授权供请求者使用。
- **缓存：** 在前端缓存中，存储与经常使用的队列相关的元数据信息。此外，用户相关数据也在此缓存中存储，以减少对身份验证和授权服务的请求时间。
- **请求分派：** 前端还负责调用另外两个服务，后端和元数据存储。区分对这两个服务的调用是前端的责任之一。
- **请求去重：** 前端还跟踪与所有请求相关的信息，因此还可防止**相同的请求**被放入队列中。决定如何处理重复项可能像在存储中搜索哈希键那样简单。如果在存储中找到了某个内容，则意味着有重复项，可以拒绝该消息。
- **使用数据收集：** 这指收集可用于审计目的的实时数据。

#### 元数据服务这个组件负责在元数据存储库和缓存中存储、检索和更新队列的元数据。每当创建或删除队列时，元数据存储库和缓存会相应地更新。元数据服务作为前端服务器和数据层之间的中间件。由于队列的元数据保存在缓存中，因此前端服务器首先会检查缓存中是否有与请求有关的任何相关信息。如果发生缓存未命中，则从元数据存储库检索信息，并相应地更新缓存。有两种不同的方法来组织元数据缓存集群：1。如果需要存储的元数据很小并且可以驻留在一个单独的计算机上，则在每个集群服务器上复制它。随后，请求可以从任何随机服务器提供服务。在这种方法中，也可以在前端服务器和元数据服务之间引入负载均衡器。![ALoadBalancerBetweenFrontEndAndMetadata](/img/17-Distributed%20Messaging%20Queue/ALoadBalancerBetweenFrontEndAndMetadata.png)在前端服务器和元数据服务之间引入负载均衡器1。如果需要存储的元数据太大，则可以遵循以下任一模式：- 第一种策略是使用分片方法将数据分成不同的片。可以根据某些分区密钥或哈希技术进行分片，就像我们所讨论的[数据库分区](https://www.educative.io/collection/page/10370001/4941429335392256/6254160546103296)的课程一样。每个分片存储在集群中的不同主机上。此外，每个分片也在不同的主机上复制以增强可用性。在这个群集组织方法中，前端服务器具有片和主机之间的映射表。因此，前端服务器负责将请求重定向到存储数据的主机。![](/img/17-Distributed%20Messaging%20Queue/MappingTableResidesOnTheFrontEndServers.png)映射表驻留在前端服务器上- 第二种方法类似于第一种方法。但是，在这种方法中，映射表存储在每个主机上，而不仅仅是存储在前端服务器上。因此，任何随机主机都可以接收请求并将其转发到存储数据的主机。这种技术非常适用于读密集型应用程序。![](/img/17-Distributed%20Messaging%20Queue/MappingTableResidesOnEachMetadataServer.png)映射表驻留在每个元数据服务器上在我们对分布式消息队列的讨论中，我们专注于这种类型队列的高级设计。此外，我们探讨了高级设计中的每个组件，包括以下内容：- 前端服务器及其所需的服务以实现平稳运行。- 负载均衡器。- 元数据服务。- 元数据集群及其组织方式。设计的重要部分是后端服务器的组织，用于队列的创建、删除和其他重要操作。下一课将重点介绍后端服务器的组织方式、队列管理以及与消息传递和检索相关的其他重要操作。