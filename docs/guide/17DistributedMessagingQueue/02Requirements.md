---
typora-root-url: ..
---

# 设计分布式消息队列的需求

学习使用草图方案设计分布式消息队列的要求。

## 需求

在**分布式消息队列**中，数据分布在多台机器上。我们的目标是设计一个分布式消息队列，具有以下功能和非功能要求。

### 功能要求

列出客户端应能执行的操作如下：

- **队列创建**：客户端应能够创建队列并设置某些参数，例如队列名称、队列大小和**最大消息大小**。通常，像Amazon Simple Queue Service（SQS）和Microsoft Messaging Queue（MSMQ）这样的流行服务允许最大大小为256KB和4MB。我们如何发送大于预定义大小的消息？发送消息大于指定允许大小采用各种方法，例如一种方法是在发送方将消息分成小块，在接收方将其组合。然而，这种方法会增加发送方和接收方的复杂性。Amazon SQS提供了扩展库，通过调用多个API（包括`AmazonSQSExtendedClient`、`ExtendedClientConfiguration`等）可以发送包含指向Amazon S3中的消息载荷的消息。类似地，Microsoft MSMQ提供了一个`MQSendLargeMessage` API，可以将大于4MB的消息作为XML文档发送。因此，我们将通过假定我们的系统支持Amazon或Microsoft采用的策略之一而忽略这种讨论。
- **发送消息**：制造者实体应能够向他们预定的队列发送消息。
- **接收消息**：使用者实体应能够从他们各自的队列接收消息。
- **删除消息**：在成功处理消息后，使用者进程应能够从队列中删除消息。
- **队列删除**：客户端应能够删除特定队列。

### 非功能需求

我们的分布式消息队列设计应符合以下非功能需求：

- **可靠性**：该系统接收到的数据应是可靠的，不应该丢失。生产者和使用者可以独立失败，具有数据耐久性的队列对于整个系统的工作至关重要，因为其他实体依赖于该队列。
- **可扩展性**：该系统需要具有可扩展性，能够处理增加的负载、队列、生产者、使用者和消息数量。类似地，当负载减少时，该系统应能够相应地缩小资源。
- **可用性**：该系统应具有高可用性，能够连续接收和发送消息。即使一个或多个组件失败，它也应继续无间断地运行。
- **性能**：该系统应具有高吞吐量和低延迟。

## 单服务器消息队列

在我们着手绘制分布式消息队列的设计之前，让我们回想一下在单个服务器中如何使用队列，其中生产者和使用者进程也在同一节点上。制造者或使用者可以通过获取锁定机制来访问单个服务器队列，以避免数据不一致。队列被认为是一个临界区，只有一个实体，即生产者或使用者，可以每次访问数据。

然而，今天的分布式系统范式中，有几个方面限制我们使用单服务器消息队列。例如，在硬件或网络故障事件中，协作进程、生产者和使用者无法使用它。此外，性能会受到锁定竞争的严重影响。此外，它既不可扩展也不耐用。![多个生产者和消费者通过一个单一的消息队列相互交互](/img/17-Distributed%20Messaging%20Queue/Multiple%20producers%20and%20consumers%20interact%20via%20a%20single%20messaging%20queue.png) 

多个生产者和消费者通过一个单一的消息队列相互交互

点拨

###### 问题

我们能否将单服务器消息队列的设计扩展到分布式消息队列？

隐藏答案

单服务器消息队列具有以下缺点：

- **高延迟：** 与单服务器消息队列一样，生产者或消费者获取锁以访问队列。因此，当许多进程尝试访问队列时，该机制成为瓶颈。这会增加服务的延迟。
- **低可用性：** 由于消息队列的缺乏复制，生产者和消费者进程可能无法在故障事件中访问队列。这降低了系统的可用性和可靠性。
- **缺乏耐久性：** 由于缺乏复制，队列中的数据可能会在系统故障时丢失。
- **可扩展性：** 单服务器消息队列只能处理有限数量的消息、生产者和消费者。因此，它不具备可伸缩性。

为将单服务器消息队列的设计扩展到分布式消息队列，我们需要进行广泛的努力，以消除上述缺点。

## 我们将使用的构建块

分布式消息队列的设计利用以下构建块：

![用于设计分布式队列的构建块](/img/17-Distributed%20Messaging%20Queue/BuildingBlocksUsedToDesignDistributedQueue.png)

用于设计分布式队列的构建块

- **数据库** 将用于存储队列和用户的元数据。
- **缓存** 对于保存用户或队列元数据相关的经常访问的数据非常重要。
- **负载均衡器** 用于将传入的请求指向存储元数据的服务器。

在我们关于消息队列的讨论中，我们关注了它们的功能和非功能要求。在进入分布式消息队列的设计过程之前，我们需要讨论一些关键注意事项和可能影响设计的挑战。