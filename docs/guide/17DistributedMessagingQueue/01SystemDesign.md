---
typora-root-url: ..
---

# 系统设计：分布式消息队列
学习什么是消息队列，为什么使用它以及重要的用例。

## 什么是消息队列？
一个 **消息队列** 是相互作用的实体——生产者和消费者之间的一个中间组件。生产者产生消息并将其放置在队列中，而消费者从队列中取出消息并进行处理。可能有多个生产者和消费者同时与队列交互。

下面是通过单个消息队列相互作用的两个应用程序的插图：

![通过单个消息队列相互作用的两个应用程序示例](/img/17-Distributed%20Messaging%20Queue/AnExampleOfTwoApplicationsInteractingViaASingleMessagingQueue.png)

<center>通过单个消息队列相互作用的两个应用程序示例</center>

### 动机
消息队列有几个优点和用例。

- **提高性能：** 消息队列使得生产者和消费者之间的异步通信成为可能，消除了它们之间的相对速度差异。生产者将消息放入队列中而无需等待消费者。同样，消费者在消息可用时进行处理。此外，队列通常用于将较慢的操作从关键路径中分离出来，因此有助于减少客户端感知的延迟。例如，代替等待需要长时间完成的特定任务，生产者进程发送一条消息，如果有多个请求，则将其保留在队列中，用于所需任务并继续其操作。消费者可以使用另一个队列通知我们处理的结果——成功或失败。

- **更好的可靠性：** 通过消息队列将相互作用的实体分离使系统更具容错性。例如，生产者或消费者可以独立故障而不影响其他实体，并在稍后重新启动。此外，将消息队列在多个服务器上复制可以确保系统在一个或多个服务器宕机时仍具有可用性。

- **细粒度可扩展性：** 异步通信使系统更具可扩展性。例如，许多进程可以通过消息队列进行通信。此外，当请求数量增加时，我们在多个消费者之间分配工作负载。因此，应用程序可以完全控制根据当前需求调整生产者或消费者进程的数量。

- **易于解耦：** 消息队列解耦了系统中不同实体之间的依赖关系。相互作用的实体通过消息进行通信，不了解彼此的内部工作机制。

- **速率限制：** 消息队列还可以帮助吸收任何负载峰值并防止服务过载，在需要避免放弃任何传入请求时作为一种原始形式的速率限制。

- **优先级队列：** 多个队列可以用于实现不同的优先级，例如每个优先级一个队列，并给更高优先级队列更多的服务时间。

### 消息队列用例
消息队列在单个服务器和分布式环境中都有很多用例。例如，它可以用于一个操作系统内部的进程间通信。它还可以在分布式环境中启用进程之间的通信。以下是消息队列的一些用例。

1. **发送大量电子邮件：** 电子邮件用于多种目的，例如共享信息、账户验证、重置密码、营销活动等。针对不同目的编写的所有这些电子邮件都不需要进行即时处理，因此它们不会干扰系统的核心功能。在这种情况下，消息队列可以帮助在不同的发送方和接收方之间协调大量的电子邮件。

2. **数据后处理：** 许多多媒体应用程序需要处理内容以满足不同观看者的需求，例如在移动电话和智能电视上消费。通常，应用程序将内容上传到存储库，并使用消息队列进行离线内容的后处理。这样做可以大大减少客户感知的延迟，并使服务能够在一些适当的时间安排离线工作—可能是在计算能力较忙碌的深夜。

3. **推荐系统：**一些平台使用推荐系统为用户提供优选内容或信息。推荐系统使用用户的历史数据进行处理，并预测相关的内容或信息。由于这是一项耗时的任务，可以在推荐系统和请求过程之间并入消息队列来增加和加速性能。

## 我们如何设计分布式消息队列？
我们将分布式消息队列的设计划分为以下五个部分：

1. **需求：** 在这里，我们关注设计分布式消息队列的功能和非功能需求。我们还在这一课程中讨论了单服务器消息队列及其缺点。

2. **设计考虑：** 在这一课程中，我们讨论可能影响分布式消息队列设计的一些重要因素——例如，将消息放入队列的顺序、消息的提取、它们在队列中的可见性以及进入消息的并发性。

3. **设计：** 在这一课程中，我们详细讨论了分布式消息队列的设计。我们还描述了队列的复制过程以及设计中所涉及的各种构建块之间的交互。

4. **评估：** 在这一课程中，我们基于其功能和非功能需求评估了分布式消息队列的设计。

5. **测验：** 在本章末尾，我们通过测验评估分布式消息队列设计的理解。

让我们从了解设计分布式消息队列的需求开始。